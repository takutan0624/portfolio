<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Partner v8 (Firebase Cloud)</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='16' fill='%2314b8a6'/%3E%3Ctext x='32' y='41' font-size='28' text-anchor='middle' fill='white' font-family='Arial, sans-serif'%3EM%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f9ff; }
        .chat-bubble { max-width: 85%; line-height: 1.6; }
        .markdown-body p { margin-bottom: 0.5em; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .icon-btn { transition: all 0.2s; }
        .icon-btn:active { transform: scale(0.9); }
        .icon-selected { transform: scale(1.2); }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center text-gray-800">

    <!-- ログイン画面 (Firebase) -->
    <div id="login-screen" class="absolute inset-0 z-50 bg-white flex flex-col items-center justify-center p-6 overflow-y-auto">
        <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 text-4xl mb-6 flex-shrink-0">
            <i class="fa-solid fa-spa"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Mental Partner</h1>
        <p class="text-gray-500 mb-8 text-sm text-center">データをクラウドに保存して、<br>いつでもどこでも振り返り。</p>
        
        <div class="flex flex-col gap-3 w-full max-w-xs">
            <button id="google-login-btn" class="bg-white border border-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl shadow-sm hover:bg-gray-50 transition flex items-center justify-center gap-3 w-full">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                <span>Googleでログイン</span>
            </button>
            
        </div>
        <p id="google-login-disabled" class="hidden mt-3 text-xs text-gray-500 text-center">
            このドメインではGoogleログインが無効です。
        </p>
        <p class="mt-4 text-[11px] text-gray-400 text-center">
            AI機能はログイン後に利用できます。
        </p>

        <!-- エラー表示エリア -->
        <div id="login-error-container" class="mt-6 w-full max-w-sm hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-xs text-red-700 break-all">
                <p class="font-bold mb-2"><i class="fa-solid fa-circle-exclamation"></i> ログインエラー</p>
                <p id="login-error-msg" class="mb-2">ドメインが許可されていません。</p>
                
                <div id="domain-instruction" class="hidden mt-2 pt-2 border-t border-red-200">
                    <p class="mb-1">以下のドメインをFirebaseコンソールの<br><strong>Authentication > 設定 > 承認済みドメイン</strong><br>に追加してください：</p>
                    <code id="current-domain" class="block bg-white p-2 rounded border border-red-100 font-mono select-all cursor-pointer hover:bg-gray-50" title="クリックしてコピー"></code>
                </div>
            </div>
        </div>
    </div>

    <!-- アプリ本体 -->
    <div id="app-container" class="hidden w-full h-full md:max-w-md md:h-[95vh] md:rounded-3xl md:shadow-2xl flex flex-col bg-white overflow-hidden relative border border-gray-100">
        
        <!-- ヘッダー -->
        <header class="bg-white/95 backdrop-blur-sm border-b border-gray-100 p-4 flex justify-between items-center z-20 absolute top-0 w-full h-16">
            <h1 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
                <i class="fa-solid fa-spa text-teal-500"></i> Mental Partner
            </h1>
            <div class="flex gap-3">
                <button id="logout-btn" class="text-gray-400 hover:text-teal-600 transition text-xs flex items-center gap-1">
                    <i class="fa-solid fa-right-from-bracket"></i> <span id="user-name"></span>
                </button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="flex-1 overflow-hidden relative pt-16 pb-16 bg-gray-50">
            
            <!-- 1. チャット -->
            <div id="view-chat" class="view-section w-full h-full flex flex-col absolute inset-0 transition-opacity duration-300 pt-16 pb-16">
                <div class="px-4 pt-3 flex justify-end">
                    <button id="summarize-btn" class="text-[10px] font-bold text-teal-700 bg-teal-50 border border-teal-100 px-3 py-1 rounded-full hover:bg-teal-100 transition">
                        会話を要約して圧縮
                    </button>
                </div>
                <div id="chat-summary-wrap" class="hidden px-4 pt-2">
                    <details class="bg-teal-50 border border-teal-100 rounded-xl p-3 text-xs text-gray-700">
                        <summary class="cursor-pointer font-bold text-teal-700">会話の要約</summary>
                        <div id="chat-summary-text" class="mt-2 whitespace-pre-wrap"></div>
                    </details>
                </div>
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
                    <!-- チャット履歴はJSでロード -->
                </div>
                <div class="p-3 bg-white border-t border-gray-100">
                    <form id="chat-form" class="flex gap-2">
                        <input type="text" id="user-input" class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm" placeholder="話しかける..." autocomplete="off">
                        <button type="submit" id="send-btn" class="bg-teal-600 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-teal-700 shadow-md transition transform active:scale-95">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- 2. チェックイン -->
            <div id="view-work" class="view-section w-full h-full absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300 overflow-y-auto pt-16 pb-20 p-4 bg-gradient-to-b from-teal-50 to-white">
                
                <div id="daily-message-area" class="bg-white p-5 rounded-2xl shadow-sm mb-6 border border-teal-100 relative hidden animate-fade-in">
                    <div class="text-xs text-gray-400 mb-2 flex items-center gap-1">
                        <i class="fa-solid fa-robot"></i> AIからのフィードバック
                    </div>
                    <p id="daily-message-text" class="text-sm text-gray-700 leading-relaxed"></p>
                    <button onclick="document.getElementById('daily-message-area').classList.add('hidden')" class="absolute top-2 right-3 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm mb-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-gray-800">チェックイン</h2>
                        <span class="text-xs text-gray-400" id="current-date"></span>
                    </div>

                    <!-- スコア (強度) -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <label class="block text-xs font-bold text-teal-600 mb-2">ココロの元気</label>
                            <div class="flex justify-between px-1">
                                <button class="icon-btn text-2xl text-gray-300 hover:text-indigo-400" onclick="setMental(1, this)"><i class="fa-solid fa-face-sad-tear"></i></button>
                                <button class="icon-btn text-2xl text-gray-300 hover:text-blue-400" onclick="setMental(2, this)"><i class="fa-solid fa-face-frown"></i></button>
                                <button class="icon-btn text-2xl text-gray-300 hover:text-gray-400" onclick="setMental(3, this)"><i class="fa-solid fa-face-meh"></i></button>
                                <button class="icon-btn text-2xl text-gray-300 hover:text-teal-400" onclick="setMental(4, this)"><i class="fa-solid fa-face-smile"></i></button>
                                <button class="icon-btn text-2xl text-gray-300 hover:text-yellow-400" onclick="setMental(5, this)"><i class="fa-solid fa-face-laugh-beam"></i></button>
                            </div>
                            <input type="hidden" id="mental-val" value="3">
                        </div>
                        <div class="text-center">
                            <label class="block text-xs font-bold text-teal-600 mb-2">カラダの元気</label>
                            <div id="physical-hearts" class="flex justify-center gap-2">
                                <button class="icon-btn text-2xl text-gray-200 hover:text-pink-400" onclick="setPhysical(1)"><i class="fa-solid fa-heart"></i></button>
                                <button class="icon-btn text-2xl text-gray-200 hover:text-pink-400" onclick="setPhysical(2)"><i class="fa-solid fa-heart"></i></button>
                                <button class="icon-btn text-2xl text-gray-200 hover:text-pink-400" onclick="setPhysical(3)"><i class="fa-solid fa-heart"></i></button>
                                <button class="icon-btn text-2xl text-gray-200 hover:text-pink-400" onclick="setPhysical(4)"><i class="fa-solid fa-heart"></i></button>
                                <button class="icon-btn text-2xl text-gray-200 hover:text-pink-400" onclick="setPhysical(5)"><i class="fa-solid fa-heart"></i></button>
                            </div>
                            <input type="hidden" id="physical-val" value="3">
                        </div>
                    </div>

                    <!-- CBT 4項目入力 -->
                    <div class="space-y-4 pt-4 border-t border-gray-100">
                        
                        <!-- 1. 状況 -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">
                                <i class="fa-regular fa-calendar text-teal-500 mr-1"></i> 1. 状況 (いつ、どこで、誰と？)
                            </label>
                            <input type="text" id="cbt-situation" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base md:text-sm focus:outline-none focus:border-teal-500" placeholder="例：仕事中にミスをして上司に注意された">
                        </div>

                        <!-- 2. 感情 -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">
                                <i class="fa-regular fa-face-flushed text-teal-500 mr-1"></i> 2. 感情 (どんな気持ち？)
                            </label>
                            <input type="text" id="cbt-emotion-text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base md:text-sm focus:outline-none focus:border-teal-500" placeholder="例：悲しい、情けない、不安 (80%)">
                        </div>

                        <!-- 3. 思考 -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">
                                <i class="fa-solid fa-cloud text-teal-500 mr-1"></i> 3. 思考 (頭に浮かんだ考え)
                            </label>
                            <textarea id="cbt-thought" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base md:text-sm focus:outline-none focus:border-teal-500 resize-none h-20" placeholder="例：自分はなんてダメなんだ、もう信用されないだろう"></textarea>
                        </div>

                        <!-- 4. 行動 -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">
                                <i class="fa-solid fa-person-walking text-teal-500 mr-1"></i> 4. 行動 (何をした？)
                            </label>
                            <input type="text" id="cbt-behavior" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base md:text-sm focus:outline-none focus:border-teal-500" placeholder="例：謝ってすぐに修正に取り掛かった、トイレで深呼吸した">
                        </div>

                    </div>

                    <button id="save-cbt-btn" class="w-full mt-6 bg-teal-600 text-white py-4 rounded-2xl text-sm font-bold shadow-lg shadow-teal-100 hover:bg-teal-700 transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check"></i> チェックイン完了
                    </button>
                </div>
                <h3 class="text-xs font-bold text-gray-400 mb-2 px-2">最近の記録</h3>
                <div id="cbt-list" class="space-y-3 pb-10"></div>
            </div>

            <!-- 3. 分析 -->
            <div id="view-analysis" class="view-section w-full h-full flex flex-col absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300 overflow-y-auto pt-16 pb-24 bg-white">
                <div class="absolute right-4 bottom-20 z-20">
                    <button id="analyze-btn" class="bg-gradient-to-r from-teal-500 to-teal-600 text-white px-3 py-2 rounded-full text-xs font-bold shadow-md hover:shadow-lg transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-[10px]"></i> 分析
                    </button>
                </div>
                <div class="px-6 py-6 border-b border-gray-100">
                    <div class="flex items-center gap-2 mb-1"><span class="bg-teal-100 text-teal-700 text-[10px] font-bold px-2 py-0.5 rounded-full">AIレターのポイント</span></div>
                    <h2 class="text-lg font-bold text-gray-800 mb-4">調子の波とできごと</h2>
                    <div class="flex gap-4 mb-2 text-xs font-bold">
                        <span class="flex items-center gap-1 text-gray-500"><span class="w-3 h-3 bg-teal-400 rounded-sm"></span>ココロ</span>
                        <span class="flex items-center gap-1 text-gray-500"><span class="w-3 h-3 bg-orange-400 rounded-sm"></span>カラダ</span>
                    </div>
                    <div class="h-[200px] w-full relative mb-4"><canvas id="waveChart"></canvas></div>
                    <div class="relative mt-2">
                        <div class="bg-teal-50 p-4 rounded-2xl rounded-tr-none text-sm text-gray-700 shadow-sm border border-teal-100 relative z-0">
                            <h4 class="text-teal-600 font-bold text-xs mb-1">今週の傾向</h4>
                            <div id="wave-analysis-text">分析ボタンを押してください。</div>
                        </div>
                        <div class="absolute -right-2 -top-8 w-12 h-12 bg-white rounded-full shadow-md flex items-center justify-center text-teal-600 border border-teal-50 z-10"><i class="fa-solid fa-robot text-xl"></i></div>
                    </div>
                </div>
                <div class="px-6 py-6 pb-10">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">思考パターン</h2>
                    <div class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm mb-6">
                        <div class="h-[300px] w-full relative"><canvas id="patternChart"></canvas></div>
                    </div>
                    <h3 class="text-sm font-bold text-teal-700 mb-3">よく出るパターン</h3>
                    <div class="grid grid-cols-3 gap-2 mb-6" id="top-patterns-container"></div>
                </div>
            </div>
        </main>

        <!-- ナビゲーション -->
        <nav class="bg-white border-t border-gray-100 h-16 flex justify-around items-center z-20 absolute bottom-0 w-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button class="nav-btn tab-active flex-1 flex flex-col items-center justify-center h-full gap-1 group" data-target="view-chat"><i class="fa-solid fa-comments text-xl mb-0.5 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">チャット</span></button>
            <button class="nav-btn tab-inactive flex-1 flex flex-col items-center justify-center h-full gap-1 group" data-target="view-work"><i class="fa-solid fa-pen-to-square text-xl mb-0.5 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">チェックイン</span></button>
            <button class="nav-btn tab-inactive flex-1 flex flex-col items-center justify-center h-full gap-1 group" data-target="view-analysis"><i class="fa-solid fa-chart-pie text-xl mb-0.5 group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">分析</span></button>
        </nav>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ▼▼▼ Firebase Config ▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyAm6Gi_FFunADHW36uP2ZexHO6cq06yG9g",
            authDomain: "my-mental-partner.firebaseapp.com",
            projectId: "my-mental-partner",
            storageBucket: "my-mental-partner.firebasestorage.app",
            messagingSenderId: "804766436088",
            appId: "1:804766436088:web:f49b22a1948cb91d3e090d",
            measurementId: "G-82DFXNL0VW"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Environment Variables
        const GROQ_MODEL = "openai/gpt-oss-120b";

        // Global State
        let currentUser = null;
        let state = {
            chatHistory: [],
            chatSummary: "",
            chatSummaryUpdatedAt: 0,
            cbtEntries: [],
            patterns: { "全か無か思考": 0, "過度の一般化": 0, "心のフィルター": 0, "マイナス化思考": 0, "結論の飛躍": 0, "拡大解釈・過小評価": 0, "感情的決めつけ": 0, "べき思考": 0, "レッテル貼り": 0, "個人化": 0 }
        };
        const EMOTION_COLORS = ['#818cf8', '#60a5fa', '#9ca3af', '#2dd4bf', '#fbbf24'];
        const CHAT_SYSTEM_PROMPT = "あなたは優秀な精神保健福祉士で認知行動療法（CBT）のカウンセラーです。日本語で、思いやりのある口調で、要点を整理しつつ1000字以内でアドバイスを返してください。過度に断定せず、具体的な一歩を提案してください。";
        const MAX_INPUT_TOKENS = 5200;
        const TOKEN_PER_CHAR = 1 / 3.5;
        const SUMMARY_MAX_INPUT_TOKENS = 3600;
        const AUTO_SUMMARY_MIN_MESSAGES = 12;
        const AUTO_SUMMARY_COOLDOWN_MS = 5 * 60 * 1000;
        const AUTO_SUMMARY_MAX_TOKENS = 4200;

        function estimateTokens(text) {
            return Math.ceil((text || "").length * TOKEN_PER_CHAR);
        }

        function buildChatMessages(history) {
            const systemContent = state.chatSummary
                ? `${CHAT_SYSTEM_PROMPT}\n\n【これまでの会話要約】\n${state.chatSummary}`
                : CHAT_SYSTEM_PROMPT;
            const system = { role: "system", content: systemContent };
            let total = estimateTokens(system.content);
            const selected = [];
            for (let i = history.length - 1; i >= 0; i--) {
                const msg = history[i];
                const content = msg?.content || "";
                const cost = estimateTokens(content);
                if (total + cost > MAX_INPUT_TOKENS) break;
                selected.push({ role: msg.role, content });
                total += cost;
            }
            return [system, ...selected.reverse()];
        }

        function buildSummaryInput(history) {
            let total = 0;
            const blocks = [];
            if (state.chatSummary) {
                const header = `【既存の要約】\n${state.chatSummary}\n\n`;
                blocks.push(header);
                total += estimateTokens(header);
            }
            const lines = [];
            for (let i = history.length - 1; i >= 0; i--) {
                const msg = history[i];
                const role = msg.role === "user" ? "User" : "Assistant";
                const line = `${role}: ${msg.content}\n`;
                const cost = estimateTokens(line);
                if (total + cost > SUMMARY_MAX_INPUT_TOKENS) break;
                lines.push(line);
                total += cost;
            }
            lines.reverse();
            blocks.push(lines.join(""));
            return blocks.join("");
        }

        function estimateHistoryTokens(history) {
            return history.reduce((sum, m) => sum + estimateTokens(m?.content || ""), 0);
        }

        function shouldAutoSummarize() {
            if (state.chatHistory.length < AUTO_SUMMARY_MIN_MESSAGES) return false;
            if (Date.now() - (state.chatSummaryUpdatedAt || 0) < AUTO_SUMMARY_COOLDOWN_MS) return false;
            const tokens = estimateHistoryTokens(state.chatHistory);
            return tokens > AUTO_SUMMARY_MAX_TOKENS;
        }

        // Auth Logic
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameEl = document.getElementById('user-name');
        const loginErrorContainer = document.getElementById('login-error-container');
        const loginErrorMsg = document.getElementById('login-error-msg');
        const domainInstruction = document.getElementById('domain-instruction');
        const currentDomainEl = document.getElementById('current-domain');
        const googleLoginDisabledMsg = document.getElementById('google-login-disabled');

        const allowedAuthDomains = [
            "localhost",
            "127.0.0.1",
            "my-mental-partner.firebaseapp.com",
            "portfolio-flame-iota-d7n8dbh5mp.vercel.app"
        ];
        const currentDomain = window.location.hostname;
        const isGoogleAuthAllowed = allowedAuthDomains.includes(currentDomain);
        if (!isGoogleAuthAllowed) {
            googleLoginBtn.classList.add('hidden');
            googleLoginDisabledMsg.classList.remove('hidden');
        }

        async function callGroq(messages, options = {}) {
            if (!currentUser) throw new Error("Not authenticated");
            if (window.location.protocol === "file:") {
                throw new Error("ローカルファイルではAPIが使えません。デプロイ先URLで開いてください。");
            }
            const token = await currentUser.getIdToken(true);
            const res = await fetch("/api/groq-mental", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    model: GROQ_MODEL,
                    messages,
                    temperature: options.temperature ?? 0.7,
                    max_tokens: options.max_tokens ?? 300,
                    response_format: options.response_format
                })
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || "Groq API error");
            }
            const data = await res.json();
            return data?.content || "...";
        }

        async function callAnalysis(prompt) {
            if (!currentUser) throw new Error("Not authenticated");
            const token = await currentUser.getIdToken(true);
            const res = await fetch("/api/groq-mental", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    analysis: true,
                    model: GROQ_MODEL,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.2,
                    max_tokens: 400
                })
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || "Groq API error");
            }
            return await res.json();
        }

        // Googleログイン
        googleLoginBtn.addEventListener('click', async () => {
            try {
                if (!isGoogleAuthAllowed) {
                    googleLoginDisabledMsg.classList.remove('hidden');
                    return;
                }
                loginErrorContainer.classList.add('hidden');
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                loginErrorMsg.textContent = error.message;
                
                // ドメイン許可エラーの場合の特別対応
                if (error.code === 'auth/unauthorized-domain') {
                    loginErrorMsg.textContent = "このプレビュー環境のドメインがFirebaseで許可されていません。";
                    currentDomainEl.textContent = window.location.hostname;
                    domainInstruction.classList.remove('hidden');
                } else {
                    domainInstruction.classList.add('hidden');
                }
                
                loginErrorContainer.classList.remove('hidden');
            }
        });

        // ゲストログイン（匿名認証）
        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userNameEl.textContent = user.isAnonymous ? "ゲスト" : (user.displayName || "ユーザー");
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await loadDataFromFirestore(user.uid);
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                state.chatHistory = [];
                state.chatSummary = "";
                state.chatSummaryUpdatedAt = 0;
                state.cbtEntries = [];
                updateSummaryUI();
            }
        });

        // コピペ用
        currentDomainEl.addEventListener('click', () => {
            const range = document.createRange();
            range.selectNode(currentDomainEl);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            alert('ドメインをコピーしました');
        });

        // Firestore Logic
        function normalizeHistory(history) {
            if (!Array.isArray(history)) return [];
            return history.map((m) => {
                if (m && typeof m.content === "string") return { role: m.role || "user", content: m.content };
                if (m && Array.isArray(m.parts) && m.parts[0]?.text) {
                    return { role: m.role === "model" ? "assistant" : (m.role || "user"), content: m.parts[0].text };
                }
                return null;
            }).filter(Boolean);
        }

        async function loadDataFromFirestore(uid) {
            // 1. Chat History (One doc for simplicity or Collection)
            // Using a single doc for chat history array to keep it simple and cheap
            const chatDocRef = doc(db, "users", uid, "data", "chatHistory");
            const chatSnap = await getDoc(chatDocRef);
            if (chatSnap.exists()) {
                const data = chatSnap.data() || {};
                state.chatHistory = normalizeHistory(data.history || []);
                state.chatSummary = data.summary || "";
                state.chatSummaryUpdatedAt = data.summaryUpdatedAt || 0;
            } else {
                state.chatHistory = [{ role: "assistant", content: "こんにちは。心の調子はいかがですか？" }];
                await setDoc(chatDocRef, { history: state.chatHistory, summary: "", summaryUpdatedAt: 0 });
            }
            renderChatHistory();

            // 2. Patterns (Analysis)
            const patternDocRef = doc(db, "users", uid, "data", "patterns");
            const patternSnap = await getDoc(patternDocRef);
            if (patternSnap.exists()) {
                const data = patternSnap.data();
                if(data.patterns) state.patterns = data.patterns;
                if(data.comment) document.getElementById('wave-analysis-text').textContent = data.comment;
            }

            // 3. CBT Entries (Subcollection for scalability)
            // Real-time listener
            const q = query(collection(db, "users", uid, "entries"), orderBy("date", "desc"), limit(20));
            onSnapshot(q, (snapshot) => {
                state.cbtEntries = [];
                snapshot.forEach((doc) => {
                    state.cbtEntries.push({ id: doc.id, ...doc.data() });
                });
                renderCbtList();
                renderCharts();
                renderTopPatterns();
            });
        }

        async function saveChatToFirestore() {
            if (!currentUser) return;
            const chatDocRef = doc(db, "users", currentUser.uid, "data", "chatHistory");
            await setDoc(chatDocRef, { history: state.chatHistory, summary: state.chatSummary, summaryUpdatedAt: state.chatSummaryUpdatedAt || 0 }, { merge: true });
        }

        async function saveAnalysisToFirestore(newPatterns, comment) {
            if (!currentUser) return;
            const patternDocRef = doc(db, "users", currentUser.uid, "data", "patterns");
            await setDoc(patternDocRef, { patterns: newPatterns, comment: comment }, { merge: true });
        }

        // --- App Logic (Adapted from v7) ---
        
        // Chat
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const summarizeBtn = document.getElementById('summarize-btn');
        const chatSummaryWrap = document.getElementById('chat-summary-wrap');
        const chatSummaryText = document.getElementById('chat-summary-text');

        function updateSummaryUI() {
            if (state.chatSummary) {
                chatSummaryText.textContent = state.chatSummary;
                chatSummaryWrap.classList.remove('hidden');
            } else {
                chatSummaryText.textContent = '';
                chatSummaryWrap.classList.add('hidden');
            }
        }

        function renderChatHistory() {
            chatContainer.innerHTML = '';
            updateSummaryUI();
            state.chatHistory.forEach(msg => {
                const isUser = msg.role === 'user';
                appendMsgToUI(msg.content, isUser ? 'user' : 'ai');
            });
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if(!text) return;
            
            appendMsgToUI(text, 'user');
            userInput.value = '';
            state.chatHistory.push({ role: "user", content: text });
            saveChatToFirestore(); // Cloud Save

            try {
                const messages = buildChatMessages(state.chatHistory);
                const reply = await callGroq(messages, { temperature: 0.7, max_tokens: 1200 });
                appendMsgToUI(reply, 'ai');
                state.chatHistory.push({ role: "assistant", content: reply });
                saveChatToFirestore(); // Cloud Save
                if (shouldAutoSummarize()) {
                    runSummary({ silent: true }).catch((e) => console.error(e));
                }
            } catch(e) { console.error(e); }
        });

        async function runSummary({ silent }) {
            const input = buildSummaryInput(state.chatHistory);
            const summaryPrompt = `以下の会話を、次回以降の相談に必要な情報だけに圧縮してください。日本語で300〜500字。箇条書きで「背景/状況」「感情/状態」「これまでの助言/対処」「未解決/次の一歩」を含めてください。\n\n${input}`;
            const summary = await callGroq(
                [
                    { role: "system", content: "あなたは会話要約の専門家です。余計な前置きは不要で、指定形式の要約だけ返してください。" },
                    { role: "user", content: summaryPrompt }
                ],
                { temperature: 0.3, max_tokens: 500 }
            );
            state.chatSummary = (summary || "").trim();
            state.chatSummaryUpdatedAt = Date.now();
            state.chatHistory = state.chatHistory.slice(-6);
            await saveChatToFirestore();
            renderChatHistory();
            if (!silent) return;
        }

        summarizeBtn.addEventListener('click', async () => {
            if (state.chatHistory.length < 2) return alert("要約する内容がありません");
            summarizeBtn.disabled = true;
            summarizeBtn.textContent = "要約中...";
            try {
                await runSummary({ silent: false });
            } catch (e) {
                console.error(e);
                alert("要約に失敗しました。もう一度お試しください。");
            } finally {
                summarizeBtn.textContent = "会話を要約して圧縮";
                summarizeBtn.disabled = false;
            }
        });

        function appendMsgToUI(text, type) {
            const isUser = type === 'user';
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start items-end gap-2'} animate-fade-in`;
            let html = '';
            if(!isUser) html += `<div class="w-8 h-8 rounded-full bg-teal-100 flex-shrink-0 flex items-center justify-center text-teal-600 text-xs"><i class="fa-solid fa-robot"></i></div>`;
            const bubbleClass = isUser ? 'bg-teal-600 text-white rounded-2xl rounded-br-none' : 'bg-white text-gray-800 rounded-2xl rounded-bl-none shadow-sm';
            const safeHtml = DOMPurify.sanitize(marked.parse(text));
            html += `<div class="${bubbleClass} p-4 chat-bubble text-sm">${safeHtml}</div>`;
            div.innerHTML = html;
            chatContainer.appendChild(div);
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        // Work / Check-in
        const mentalValInput = document.getElementById('mental-val');
        const physicalValInput = document.getElementById('physical-val');
        const cbtSituation = document.getElementById('cbt-situation');
        const cbtEmotionText = document.getElementById('cbt-emotion-text');
        const cbtThought = document.getElementById('cbt-thought');
        const cbtBehavior = document.getElementById('cbt-behavior');
        const saveCbtBtn = document.getElementById('save-cbt-btn');
        const dailyMessageArea = document.getElementById('daily-message-area');
        const dailyMessageText = document.getElementById('daily-message-text');

        window.setMental = (val, btn) => {
            mentalValInput.value = val;
            const buttons = btn.parentElement.querySelectorAll('button');
            buttons.forEach((b, i) => {
                b.className = `icon-btn text-3xl ${i + 1 === val ? 'icon-selected ' + ['text-indigo-400','text-blue-400','text-gray-400','text-teal-400','text-yellow-400'][i] : 'text-gray-300'}`;
            });
        };

        window.setPhysical = (val) => {
            physicalValInput.value = val;
            const container = document.getElementById('physical-hearts');
            if (!container) return;
            container.querySelectorAll('button').forEach((b, i) => {
                b.className = `icon-btn text-2xl ${i < val ? 'text-pink-400' : 'text-gray-200'} ${i + 1 === val ? 'icon-selected' : ''}`;
            });
        };

        saveCbtBtn.addEventListener('click', async () => {
            if (!currentUser) return alert("ログインしてください");
            
            saveCbtBtn.disabled = true;
            saveCbtBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 保存中...';

            const entryData = {
                date: new Date().toISOString(),
                mental: parseInt(mentalValInput.value) * 20,
                physical: parseInt(physicalValInput.value) * 20,
                situation: cbtSituation.value || "",
                emotion: cbtEmotionText.value || "",
                thought: cbtThought.value || "",
                behavior: cbtBehavior.value || ""
            };

            // Cloud Save
            await addDoc(collection(db, "users", currentUser.uid, "entries"), entryData);

            // Generate Feedback
            try {
                const prompt = `ユーザーがメンタルケアアプリでチェックインしました。優しく労るフィードバック（100文字程度）を生成してください。冒頭は「おはようございます、${currentUser.displayName || "ゲスト"}さん」等。スコア(5段階): ココロ ${mentalValInput.value}, カラダ ${physicalValInput.value} 状況: ${entryData.situation} 感情: ${entryData.emotion} 思考: ${entryData.thought} 行動: ${entryData.behavior}`;
                const reply = await callGroq([{ role: "user", content: prompt }], { temperature: 0.7, max_tokens: 200 });
                dailyMessageText.innerText = reply || "保存しました。";
                dailyMessageArea.classList.remove('hidden');
            } catch(e) { console.error(e); }

            cbtSituation.value = '';
            cbtEmotionText.value = '';
            cbtThought.value = '';
            cbtBehavior.value = '';
            saveCbtBtn.innerHTML = '<i class="fa-solid fa-check"></i> チェックイン完了';
            saveCbtBtn.disabled = false;
        });

        function renderCbtList() {
            const list = document.getElementById('cbt-list');
            list.innerHTML = '';
            state.cbtEntries.slice(0, 5).forEach(entry => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl border border-gray-100 shadow-sm';
                const date = new Date(entry.date);
                const mentalIdx = Math.min(4, Math.max(0, (entry.mental / 20) - 1));
                const faces = ['fa-face-sad-tear', 'fa-face-frown', 'fa-face-meh', 'fa-face-smile', 'fa-face-laugh-beam'];
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid ${faces[mentalIdx]}" style="color: ${EMOTION_COLORS[mentalIdx]}; font-size: 1.2rem;"></i>
                            <div class="text-xs text-gray-400 font-bold">${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}</div>
                        </div>
                        <div class="flex text-pink-400 text-xs gap-0.5">${Array(Math.floor(entry.physical/20)).fill('<i class="fa-solid fa-heart"></i>').join('')}</div>
                    </div>
                    ${entry.thought ? `<div class="text-sm text-gray-700 bg-gray-50 p-2 rounded-lg">"${DOMPurify.sanitize(entry.thought)}"</div>` : ''}
                `;
                list.appendChild(el);
            });
        }

        // Analysis
        const analyzeBtn = document.getElementById('analyze-btn');
        analyzeBtn.addEventListener('click', async () => {
            if(state.cbtEntries.length < 1) return alert("データがありません");
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 分析中...';

            const thoughts = state.cbtEntries
                .slice(0, 10)
                .map(e => [e.situation, e.emotion, e.thought, e.behavior].filter(Boolean).join(" / "))
                .filter(t => t)
                .join("\n");
            const scores = state.cbtEntries.slice(0,7).map(e => `[${new Date(e.date).toLocaleDateString()}] 心:${e.mental} 体:${e.physical}`).join(", ");
            const prompt = `ユーザーの記録を分析し、<json>...</json> でJSONのみを返してください。1. patterns:「10の認知の歪み」カウント。2. comment: 今週の傾向コメント(100字)。データ: テキスト:${thoughts} スコア:${scores} 出力形式: <json>{"patterns":{"全か無か思考":0,"過度の一般化":0,"心のフィルター":0,"マイナス化思考":0,"結論の飛躍":0,"拡大解釈・過小評価":0,"感情的決めつけ":0,"べき思考":0,"レッテル貼り":0,"個人化":0},"comment":"..."}</json>`;

            try {
                const result = await callAnalysis(prompt);
                
                state.patterns = result.patterns;
                document.getElementById('wave-analysis-text').textContent = result.comment;
                
                await saveAnalysisToFirestore(result.patterns, result.comment); // Cloud Save
                renderCharts();
                renderTopPatterns();
            } catch(e) { console.error(e); } finally {
                analyzeBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> データを分析する';
                analyzeBtn.disabled = false;
            }
        });

        // Charts
        let waveChartInstance, patternChartInstance;
        function renderCharts() {
            // Wave Chart
            const ctxWave = document.getElementById('waveChart').getContext('2d');
            const waveData = [...state.cbtEntries].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-7);
            if(waveChartInstance) waveChartInstance.destroy();
            waveChartInstance = new Chart(ctxWave, {
                type: 'line',
                data: {
                    labels: waveData.map(d => new Date(d.date).toLocaleDateString(undefined, {weekday:'short'})),
                    datasets: [
                        { label: 'ココロ', data: waveData.map(d => d.mental), borderColor: '#2dd4bf', backgroundColor: 'rgba(45, 212, 191, 0.2)', fill: true, tension: 0.4 },
                        { label: 'カラダ', data: waveData.map(d => d.physical), borderColor: '#fb923c', backgroundColor: 'rgba(251, 146, 60, 0.2)', fill: true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            // Pattern Chart
            const ctxPat = document.getElementById('patternChart').getContext('2d');
            const labels = Object.keys(state.patterns);
            const patData = Object.values(state.patterns);
            if(patternChartInstance) patternChartInstance.destroy();
            patternChartInstance = new Chart(ctxPat, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: patData, backgroundColor: labels.map((_, i) => i%2===0?'#99f6e4':'#bae6fd'), borderRadius: 4, barThickness: 12 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderTopPatterns() {
            const container = document.getElementById('top-patterns-container');
            container.innerHTML = '';
            const sorted = Object.entries(state.patterns).sort((a, b) => b[1] - a[1]).slice(0, 3);
            if(sorted.every(x => x[1] === 0)) { container.innerHTML = '<div class="col-span-3 text-center text-xs text-gray-400 py-4">データなし</div>'; return; }
            sorted.forEach(([name]) => {
                container.innerHTML += `<div class="p-3 rounded-xl border border-teal-50 shadow-sm flex flex-col items-center justify-center text-center bg-gradient-to-b from-white to-teal-50"><span class="text-[10px] font-bold text-gray-600">${name}</span></div>`;
            });
        }

        // Navigation
        const views = ['view-chat', 'view-work', 'view-analysis'];
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                views.forEach(id => {
                    const el = document.getElementById(id);
                    el.style.opacity = (id === target) ? '1' : '0';
                    el.style.pointerEvents = (id === target) ? 'auto' : 'none';
                });
                document.querySelectorAll('.nav-btn').forEach(b => {
                    const active = b.dataset.target === target;
                    b.className = `nav-btn flex-1 flex flex-col items-center justify-center h-full gap-1 group ${active ? 'tab-active text-teal-600' : 'tab-inactive text-gray-400'}`;
                });
                if(target === 'view-analysis') setTimeout(renderCharts, 100);
            });
        });

        // Init UI
        setMental(3, document.querySelectorAll('#view-work .icon-btn')[2]);
        setPhysical(3);
        const d = new Date();
        document.getElementById('current-date').textContent = `${d.getMonth()+1}/${d.getDate()}`;
    </script>
</body>
</html>
