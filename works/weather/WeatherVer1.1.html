<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; img-src 'self' https: data:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; connect-src 'self' https:; frame-src 'self' https:; object-src 'none'; base-uri 'self'; form-action 'self' https:; frame-ancestors 'none'; upgrade-insecure-requests;">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=(), interest-cohort=()">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Weather Immersive - Light Glass</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" / integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Noto+Sans+JP:wght@300;500;700&display=swap');
        
        :root {
            /* ÈÄèÊòé„Å™„Ç¨„É©„Çπ„Éô„Éº„ÇπÔºàÁôΩÂü∫Ë™øÔºâ */
            --glass: rgba(255, 255, 255, 0.15);
            --border: rgba(255, 255, 255, 0.7);
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #e0e7ff 0%, #f1f5f9 100%);
            color: var(--text-main);
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            transition: background 1.5s ease;
        }

        /* Fullscreen Background Canvas */
        #weather-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            pointer-events: none;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--border);
            box-shadow:
                0 8px 32px 0 rgba(31, 38, 135, 0.15),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 1.5rem;
            /* „Éï„Ç£„É´„Çø„Éº„ÇíËß£Èô§„Åó„Å¶ÊòºÈñì„É¢„Éº„Éâ„ÇíÈÆÆ„ÇÑ„Åã„Å´ */
            filter: none;
        }

        .forecast-scroll::-webkit-scrollbar {
            height: 4px;
        }
        .forecast-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Hero Temp text glow */
        .temp-glow {
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .animate-spin-slow {
            animation: spin 8s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
        @media (max-width: 1024px) {
            #map { height: 350px; }
        }

        @media (max-width: 768px) {
            #temp { font-size: 4rem !important; }
            #weather-icon { font-size: 4rem !important; }
            #weather-desc { font-size: 1rem !important; }
            .glass { padding: 1.5rem !important; }
            #map { height: 300px; }
            .forecast-scroll { padding-bottom: 1rem; }
        }

        @media (max-width: 640px) {
            #temp { font-size: 3rem !important; }
            #weather-icon { font-size: 3rem !important; }
            #feels-like { font-size: 0.75rem !important; }
            .glass { padding: 1rem !important; }
            .grid.grid-cols-2 { gap: 0.75rem; }
            #map { height: 250px; }
            body { padding: 0.5rem !important; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- Background Layer (Weather Visualizer) -->
    <canvas id="weather-canvas"></canvas>

    <div class="w-full max-w-6xl z-10">
        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Hero Section -->
            <div class="lg:col-span-5 flex flex-col gap-6">
                <div class="glass p-8 rounded-[2.5rem] flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div class="absolute top-6 left-8 flex items-center gap-2">
                        <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
                        <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-500">Live Status</span>
                    </div>

                    <div id="weather-icon" class="text-8xl my-6 filter drop-shadow-xl">‚ú®</div>
                    <h2 id="weather-desc" class="text-2xl font-light tracking-widest text-slate-500 mb-2">LOADING...</h2>
                    <div id="temp" class="text-8xl font-bold temp-glow mb-2 tracking-tighter text-slate-800">--¬∞</div>
                    <div id="feels-like" class="text-sm text-slate-400 mb-6">‰ΩìÊÑü --¬∞</div>
                    
                    <div class="flex gap-12 border-t border-slate-200/50 pt-8 w-full justify-center">
                        <div class="text-center">
                            <p class="text-[10px] text-slate-400 uppercase mb-1">Max</p>
                            <p id="today-max" class="text-xl font-bold text-rose-500">--¬∞</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] text-slate-400 uppercase mb-1">Min</p>
                            <p id="today-min" class="text-xl font-bold text-blue-500">--¬∞</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass p-5 rounded-3xl flex flex-col items-center">
                        <span class="text-[10px] text-slate-400 uppercase mb-2">Wind</span>
                        <div class="flex items-center gap-2">
                            <span id="wind-arrow" class="text-xl transform transition-transform" style="display: inline-block;">‚Üì</span>
                            <div class="flex items-baseline gap-1">
                                <span id="windspeed" class="text-2xl font-bold text-slate-700">--</span>
                                <span class="text-xs text-slate-400 font-bold">km/h</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-3xl flex flex-col items-center">
                        <span class="text-[10px] text-slate-400 uppercase mb-2">Pressure</span>
                        <div class="flex items-baseline gap-1">
                            <span id="pressure" class="text-2xl font-bold text-slate-700">--</span>
                            <span class="text-xs text-slate-400 font-bold">hPa</span>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-3xl flex flex-col items-center">
                        <span class="text-[10px] text-slate-400 uppercase mb-2">Humidity</span>
                        <div class="flex items-baseline gap-1">
                            <span id="humidity" class="text-2xl font-bold text-slate-700">--</span>
                            <span class="text-xs text-slate-400 font-bold">%</span>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-3xl flex flex-col items-center">
                        <span class="text-[10px] text-slate-400 uppercase mb-2">UV Index</span>
                        <div class="flex items-baseline gap-1">
                            <span id="uv-index" class="text-2xl font-bold text-slate-700">--</span>
                            <span class="text-xs text-slate-400 font-bold"></span>
                        </div>
                    </div>
                </div>

                <!-- Sunrise/Sunset -->
                <div class="glass p-5 rounded-3xl">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üåÖ</span>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase">Sunrise</p>
                                <p id="sunrise" class="text-lg font-bold text-slate-700">--:--</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üåá</span>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase">Sunset</p>
                                <p id="sunset" class="text-lg font-bold text-slate-700">--:--</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200/50 text-center">
                        <p id="sun-countdown" class="text-sm text-slate-500">--</p>
                    </div>
                </div>
            </div>

            <!-- Map & Forecast Section -->
            <div class="lg:col-span-7 flex flex-col gap-6">
                <!-- 24-Hour Forecast Graph -->
                <div class="glass p-6 md:p-8 rounded-[2.5rem]">
                    <h3 class="text-sm font-bold tracking-[0.3em] text-slate-400 uppercase mb-6">24-Hour Forecast</h3>
                    <div class="relative h-40 md:h-48" id="hourly-chart-container">
                        <canvas id="hourly-chart"></canvas>
                    </div>
                </div>

                <!-- Map -->
                <div class="glass p-2 rounded-[2.5rem] overflow-hidden">
                    <div id="map"></div>
                    <!-- Radar Timeline Controls -->
                    <div id="radar-controls" class="mt-3 px-4 pb-2" style="display: none;">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleRadarPlay()" id="play-btn" class="text-xl hover:scale-110 transition-transform">‚ñ∂Ô∏è</button>
                            <input type="range" id="radar-slider" min="0" max="0" value="0"
                                   class="flex-1 h-2 bg-slate-200/50 rounded-lg appearance-none cursor-pointer"
                                   oninput="updateRadarFrame(this.value)"
                                   style="accent-color: #3b82f6;">
                            <span id="radar-time" class="text-[10px] font-bold text-slate-600 min-w-[80px] text-right">--:--</span>
                        </div>
                    </div>
                </div>

                <!-- Forecast -->
                <div class="glass p-8 rounded-[2.5rem]">
                    <div class="flex justify-between items-end mb-6">
                        <h3 class="text-sm font-bold tracking-[0.3em] text-slate-400 uppercase">Weekly Forecast</h3>
                        <button onclick="updateAll()" class="text-[10px] font-bold py-2 px-4 rounded-full border border-slate-200 hover:bg-white/50 transition-all text-slate-600">
                            REFRESH DATA
                        </button>
                    </div>
                    <div id="forecast-list" class="forecast-scroll flex overflow-x-auto gap-4 pb-2">
                        <!-- Cards injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 flex justify-between items-center px-4">
            <div class="flex gap-4 text-[10px] font-bold text-slate-400 tracking-widest uppercase">
                <span id="lat-display">LAT: --</span>
                <span id="lon-display">LON: --</span>
            </div>
            <div class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">
                &copy; 2024 Vibe Coding / Weather Experience
            </div>
        </footer>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>

    <script>
        function escapeHTML(str) {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        let map, marker, canvas, ctx, animationId;
        let particles = [];
        let currentWeatherType = 'sunny';
        let currentHumidity = 50;
        let currentWeatherCode = 0;
        let radarLayer = null;
        let radarFrames = [];
        let currentFrameIndex = 0;
        let isRadarPlaying = false;
        let radarPlayInterval = null;
        let sunCountdownInterval = null;
        let sunriseTime = null;
        let sunsetTime = null;
        let tomorrowSunriseTime = null;
        let hourlyChart = null;

        const weatherCodeMap = {
            0: { desc: "Clear Sky", emoji: "‚òÄÔ∏è", color: "#FBBF24", type: "sunny", bg: "linear-gradient(135deg, #87CEEB 0%, #E0F6FF 50%, #FFF4E0 100%)" },
            1: { desc: "Mainly Clear", emoji: "üå§Ô∏è", color: "#FBBF24", type: "sunny", bg: "linear-gradient(135deg, #93D5F0 0%, #E8F4F8 50%, #FFF8E7 100%)" },
            2: { desc: "Partly Cloudy", emoji: "‚õÖ", color: "#94A3B8", type: "cloudy", bg: "linear-gradient(135deg, #B8C6DB 0%, #D5DDE8 50%, #E8EDF2 100%)" },
            3: { desc: "Overcast", emoji: "‚òÅÔ∏è", color: "#64748B", type: "cloudy", bg: "linear-gradient(135deg, #8B98A8 0%, #B8C1CC 50%, #D4DAE1 100%)" },
            45: { desc: "Fog", emoji: "üå´Ô∏è", color: "#94A3B8", type: "fog", bg: "linear-gradient(135deg, #A8B5C7 0%, #C8D0DB 50%, #E0E5EB 100%)" },
            61: { desc: "Slight Rain", emoji: "‚òî", color: "#38BDF8", type: "rain", bg: "linear-gradient(135deg, #5A7C9B 0%, #8AA6BA 50%, #B8CDD9 100%)" },
            63: { desc: "Rain", emoji: "üåßÔ∏è", color: "#0EA5E9", type: "rain", bg: "linear-gradient(135deg, #4A6B85 0%, #6B8BA3 50%, #8FA9BC 100%)" },
            71: { desc: "Snow", emoji: "‚ùÑÔ∏è", color: "#F1F5F9", type: "snow", bg: "linear-gradient(135deg, #C5D8E8 0%, #E3EEF7 50%, #F5F9FC 100%)" },
            80: { desc: "Showers", emoji: "üå¶Ô∏è", color: "#0EA5E9", type: "rain", bg: "linear-gradient(135deg, #5A7C9B 0%, #8AA6BA 50%, #B8CDD9 100%)" },
            95: { desc: "Thunderstorm", emoji: "‚õàÔ∏è", color: "#6366F1", type: "storm", bg: "linear-gradient(135deg, #3D4A5C 0%, #5C6B7D 50%, #7A8A9C 100%)" }
        };

        window.onload = () => {
            initCanvas();
            initMap();
            updateAll();
        };

        function initMap() {
            // ÊòºÈñì„É¢„Éº„Éâ„ÅÆ„Éû„ÉÉ„Éó„Çø„Ç§„É´ (CartoDB Voyager)
            map = L.map('map', { zoomControl: false }).setView([35.68, 139.76], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            // Èõ®Èõ≤„É¨„Éº„ÉÄ„Éº„ÇíËøΩÂä†
            addRadarLayer();
        }

        async function addRadarLayer() {
            try {
                // RainViewer„ÅÆAPI„Åã„ÇâÈÅéÂéª„Å®Êú™Êù•„ÅÆ„É¨„Éº„ÉÄ„ÉºÁîªÂÉè„ÇíÂèñÂæó
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();

                if (data && data.radar) {
                    // ÈÅéÂéª„Å®ÁèæÂú®„ÅÆ„Éï„É¨„Éº„É†„ÇíÁµêÂêàÔºàÊú™Êù•‰∫àÊ∏¨„ÅØ nowcastÔºâ
                    radarFrames = [...data.radar.past];
                    if (data.radar.nowcast) {
                        radarFrames = [...radarFrames, ...data.radar.nowcast];
                    }

                    if (radarFrames.length > 0) {
                        // „Çπ„É©„Ç§„ÉÄ„Éº„ÇíË®≠ÂÆö
                        const slider = document.getElementById('radar-slider');
                        slider.max = radarFrames.length - 1;
                        // ÁèæÂú®ÊôÇÂàª„Å´ÊúÄ„ÇÇËøë„ÅÑ„Éï„É¨„Éº„É†„ÇíÂàùÊúüÂÄ§„Å´
                        currentFrameIndex = data.radar.past.length - 1;
                        slider.value = currentFrameIndex;

                        // „Ç≥„É≥„Éà„É≠„Éº„É´„ÇíË°®Á§∫
                        document.getElementById('radar-controls').style.display = 'block';

                        // ÊúÄÊñ∞„ÅÆ„É¨„Éº„ÉÄ„ÉºÁîªÂÉè„ÇíË°®Á§∫
                        updateRadarFrame(currentFrameIndex);
                    }
                }
            } catch (e) {
                console.log('Èõ®Èõ≤„É¨„Éº„ÉÄ„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', e);
            }
        }

        function updateRadarFrame(index) {
            currentFrameIndex = parseInt(index);

            if (radarFrames.length === 0 || !radarFrames[currentFrameIndex]) return;

            const frame = radarFrames[currentFrameIndex];

            // Êó¢Â≠ò„ÅÆ„É¨„Éº„ÉÄ„Éº„É¨„Ç§„É§„Éº„ÇíÂâäÈô§
            if (radarLayer) {
                map.removeLayer(radarLayer);
            }

            // Êñ∞„Åó„ÅÑ„É¨„Éº„ÉÄ„Éº„É¨„Ç§„É§„Éº„ÇíËøΩÂä†
            radarLayer = L.tileLayer(
                `https://tilecache.rainviewer.com/v2/radar/${frame.path}/256/{z}/{x}/{y}/4/1_1.png`,
                {
                    opacity: 0.6,
                    attribution: 'Rain radar: <a href="https://www.rainviewer.com">RainViewer</a>',
                    zIndex: 10
                }
            ).addTo(map);

            // ÊôÇÂàª„ÇíË°®Á§∫
            const date = new Date(frame.time * 1000);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            document.getElementById('radar-time').innerText = `${hours}:${minutes}`;
        }

        function initCanvas() {
            canvas = document.getElementById('weather-canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', () => {
                resizeCanvas();
                startVisualizer(currentWeatherType);
            });
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        async function updateAll() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    document.getElementById('lat-display').innerText = `LAT: ${lat.toFixed(4)}`;
                    document.getElementById('lon-display').innerText = `LON: ${lon.toFixed(4)}`;

                    map.setView([lat, lon], 14);
                    if (marker) map.removeLayer(marker);
                    marker = L.circleMarker([lat, lon], { color: '#6366F1', radius: 8, fillOpacity: 0.8, weight: 2 }).addTo(map);

                    const data = await fetchWeather(lat, lon);
                    if (data) {
                        updateUI(data);
                        currentWeatherType = (weatherCodeMap[data.current.weather_code] || {type: 'sunny'}).type;
                        currentHumidity = data.current.relative_humidity_2m || 50;
                        currentWeatherCode = data.current.weather_code || 0;
                        startVisualizer(currentWeatherType);
                    }
                });
            }
        }

        async function fetchWeather(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,weather_code,wind_speed_10m,wind_direction_10m,apparent_temperature&hourly=temperature_2m,precipitation_probability&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,uv_index_max,sunrise,sunset&timezone=auto&forecast_days=7`;
            try {
                const res = await fetch(url);
                return await res.json();
            } catch (e) { return null; }
        }

        function updateUI(data) {
            const current = data.current;
            const info = weatherCodeMap[current.weather_code] || { desc: "Unknown", emoji: "‚ú®", color: "#FFF", bg: "linear-gradient(135deg, #e0e7ff 0%, #f1f5f9 100%)" };

            document.getElementById('temp').innerText = `${Math.round(current.temperature_2m)}¬∞`;
            document.getElementById('feels-like').innerText = `‰ΩìÊÑü ${Math.round(current.apparent_temperature)}¬∞`;
            document.getElementById('weather-desc').innerText = info.desc.toUpperCase();
            document.getElementById('weather-icon').innerText = info.emoji;
            document.getElementById('windspeed').innerText = Math.round(current.wind_speed_10m);

            // È¢®Âêë„ÅÆÁü¢Âç∞„ÇíÊõ¥Êñ∞
            const windArrow = document.getElementById('wind-arrow');
            windArrow.style.transform = `rotate(${current.wind_direction_10m}deg)`;

            document.getElementById('pressure').innerText = Math.round(current.surface_pressure || 1013);
            document.getElementById('humidity').innerText = Math.round(current.relative_humidity_2m || 0);
            document.getElementById('uv-index').innerText = (data.daily.uv_index_max[0] || 0).toFixed(1);

            document.getElementById('today-max').innerText = `${Math.round(data.daily.temperature_2m_max[0])}¬∞`;
            document.getElementById('today-min').innerText = `${Math.round(data.daily.temperature_2m_min[0])}¬∞`;

            // Êó•„ÅÆÂá∫/Êó•„ÅÆÂÖ•„Çä
            sunriseTime = new Date(data.daily.sunrise[0]);
            sunsetTime = new Date(data.daily.sunset[0]);
            tomorrowSunriseTime = new Date(data.daily.sunrise[1]);
            document.getElementById('sunrise').innerText = `${sunriseTime.getHours().toString().padStart(2, '0')}:${sunriseTime.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('sunset').innerText = `${sunsetTime.getHours().toString().padStart(2, '0')}:${sunsetTime.getMinutes().toString().padStart(2, '0')}`;

            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÇíÈñãÂßã
            startSunCountdown();

            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò
            currentHumidity = current.relative_humidity_2m || 50;
            currentWeatherCode = current.weather_code || 0;

            // ËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
            document.body.style.background = info.bg;

            // 24ÊôÇÈñì‰∫àÂ†±„Ç∞„É©„Éï„ÇíÊèèÁîª
            drawHourlyChart(data);

            const list = document.getElementById('forecast-list');
            list.innerHTML = '';
            for (let i = 1; i < 7; i++) {
                const date = new Date(data.daily.time[i]);
                const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                const fInfo = weatherCodeMap[data.daily.weathercode[i]] || { emoji: "‚ú®" };
                const precipProb = data.daily.precipitation_probability_max[i] || 0;

                const card = document.createElement('div');
                card.className = "min-w-[120px] glass p-6 rounded-3xl flex flex-col items-center justify-center text-center";
                card.innerHTML = `
                    <span class="text-[10px] font-bold text-slate-400 uppercase mb-3">${escapeHTML(day)}</span>
                    <span class="text-3xl mb-3">${escapeHTML(fInfo.emoji)}</span>
                    <span class="text-lg font-bold text-slate-700">${Math.round(data.daily.temperature_2m_max[i])}¬∞</span>
                    <span class="text-[10px] text-slate-400 font-bold">${Math.round(data.daily.temperature_2m_min[i])}¬∞</span>
                    <div class="mt-2 flex items-center gap-1">
                        <span class="text-[9px] text-blue-500 font-bold">üíß${precipProb}%</span>
                    </div>
                `;
                list.appendChild(card);
            }
        }

        // --- Visualizer Logic ---

        function startVisualizer(type) {
            cancelAnimationFrame(animationId);
            particles = [];
            let count = 60;

            if (type === 'rain' || type === 'snow') {
                count = 150;
            } else if (type === 'cloudy') {
                // Êõá„ÇäÂ∫¶Âêà„ÅÑ: 2=Partly Cloudy, 3=Overcast
                const cloudiness = currentWeatherCode === 3 ? 1.5 : 1.0;
                // ÊπøÂ∫¶„Å´„Çà„ÇãË™øÊï¥: ÊπøÂ∫¶„ÅåÈ´ò„ÅÑ„Åª„Å©Èõ≤„ÅåÂ§ö„ÅÑ
                const humidityFactor = currentHumidity / 100;
                count = Math.floor(30 * cloudiness * (0.5 + humidityFactor));
            }

            for(let i = 0; i < count; i++) particles.push(new Particle(type));
            animate();
        }

        class Particle {
            constructor(type) {
                this.type = type;
                this.reset();
            }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1.5;
                this.opacity = Math.random() * 0.5 + 0.3;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = Math.random() * 1 + 0.5;

                if (this.type === 'rain') {
                    this.vy = Math.random() * 20 + 15; // „Çà„ÇäÈÄü„ÅèÈôç„Çã
                    this.vx = Math.random() * -3 - 1; // È¢®„ÅßÊñú„ÇÅ„Å´
                    this.size = Math.random() * 2 + 1;
                    this.length = Math.random() * 15 + 10; // Èõ®Á≤í„ÅÆÈï∑„Åï
                    this.opacity = Math.random() * 0.6 + 0.4;
                } else if (this.type === 'snow') {
                    this.vy = Math.random() * 2 + 0.8; // „ÇÜ„Å£„Åè„ÇäËêΩ„Å°„Çã
                    this.vx = Math.sin(Date.now() / 1000 + Math.random() * 1000) * 0.5; // „Åµ„Çè„Åµ„ÇèÂ∑¶Âè≥„Å´Êè∫„Çå„Çã
                    this.size = Math.random() * 4 + 2;
                    this.rotation = Math.random() * Math.PI * 2; // ÂõûËª¢ËßíÂ∫¶
                    this.rotationSpeed = (Math.random() - 0.5) * 0.02; // ÂõûËª¢ÈÄüÂ∫¶
                    this.opacity = Math.random() * 0.7 + 0.3;
                } else if (this.type === 'sunny') {
                    this.vy = -Math.random() * 0.8;
                    this.size = Math.random() * 20 + 8;
                    this.opacity = Math.random() * 0.25 + 0.15;
                } else if (this.type === 'cloudy') {
                    this.vx = Math.random() * 0.8 + 0.3; // Âè≥ÊñπÂêë„Å´„ÇÜ„Å£„Åè„ÇäÊºÇ„ÅÜ
                    this.vy = (Math.random() - 0.5) * 0.2; // Â∞ë„Åó„Å†„Åë‰∏ä‰∏ã„Å´Âãï„Åè
                    this.size = Math.random() * 40 + 30; // Èõ≤„ÅÆ„Çµ„Ç§„Ç∫
                    this.opacity = Math.random() * 0.4 + 0.2;
                }
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;

                // Èõ™„ÅÆÂõûËª¢„Å®„Åµ„Çè„Åµ„ÇèÂãï„Åç
                if (this.type === 'snow') {
                    this.rotation += this.rotationSpeed;
                    this.vx = Math.sin(Date.now() / 1000 + this.y / 50) * 0.5;
                }

                if (this.y > canvas.height + 20 || this.y < -20 || this.x > canvas.width + 20 || this.x < -20) {
                    this.reset();
                    if (this.type === 'sunny') this.y = canvas.height + 10;
                    else this.y = -10;
                }
            }
            draw() {
                ctx.beginPath();
                if (this.type === 'rain') {
                    // „Çà„ÇäÈï∑„ÅÑÈõ®Á≤í
                    ctx.strokeStyle = `rgba(59, 130, 246, ${this.opacity})`;
                    ctx.lineWidth = this.size;
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + this.vx * 0.5, this.y + this.length);
                    ctx.stroke();
                } else if (this.type === 'snow') {
                    // Èõ™„ÅÆÁµêÊô∂„ÇíÊèèÁîª
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);

                    // ‰∏≠ÂøÉ„ÅÆÂÜÜ
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size * 0.3, 0, Math.PI * 2);
                    ctx.fill();

                    // 6Êú¨„ÅÆÁ∑öÔºàÈõ™„ÅÆÁµêÊô∂Ôºâ
                    ctx.strokeStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    ctx.lineWidth = this.size * 0.15;
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI * 2 * i) / 6;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(Math.cos(angle) * this.size, Math.sin(angle) * this.size);
                        ctx.stroke();
                    }

                    ctx.restore();
                } else if (this.type === 'sunny') {
                    // Â§™ÈôΩ„ÅÆÂΩ¢„ÇíÊèèÁîªÔºà‰∏≠ÂøÉ„ÅÆÂÜÜ + Âë®„Çä„ÅÆÂÖâÁ∑öÔºâ
                    const rays = 8;
                    const coreRadius = this.size * 0.3;
                    const rayLength = this.size * 0.7;

                    // ÂÖâÁ∑ö„ÇíÊèè„Åè
                    ctx.strokeStyle = `rgba(251, 146, 60, ${this.opacity * 0.8})`;
                    ctx.lineWidth = this.size * 0.08;
                    for (let i = 0; i < rays; i++) {
                        const angle = (Math.PI * 2 * i) / rays + (Date.now() / 3000);
                        const x1 = this.x + Math.cos(angle) * coreRadius;
                        const y1 = this.y + Math.sin(angle) * coreRadius;
                        const x2 = this.x + Math.cos(angle) * rayLength;
                        const y2 = this.y + Math.sin(angle) * rayLength;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    }

                    // ‰∏≠ÂøÉ„ÅÆÂÜÜ„ÇíÊèè„Åè
                    ctx.fillStyle = `rgba(251, 191, 36, ${this.opacity})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, coreRadius, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.type === 'cloudy') {
                    // Èõ≤„ÅÆÂΩ¢„ÇíÊèèÁîªÔºàË§áÊï∞„ÅÆÂÜÜ„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„ÇãÔºâ
                    ctx.fillStyle = `rgba(148, 163, 184, ${this.opacity})`;

                    // Èõ≤„ÅØ3-5ÂÄã„ÅÆÈáç„Å™„Å£„ÅüÂÜÜ„ÅßÊßãÊàê
                    const circles = [
                        { x: -this.size * 0.3, y: 0, r: this.size * 0.4 },
                        { x: this.size * 0.1, y: -this.size * 0.15, r: this.size * 0.5 },
                        { x: this.size * 0.4, y: 0, r: this.size * 0.35 },
                        { x: this.size * 0.05, y: this.size * 0.1, r: this.size * 0.3 }
                    ];

                    circles.forEach(circle => {
                        ctx.beginPath();
                        ctx.arc(this.x + circle.x, this.y + circle.y, circle.r, 0, Math.PI * 2);
                        ctx.fill();
                    });
                } else {
                    ctx.fillStyle = `rgba(100, 116, 139, ${this.opacity})`;
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function animate() {
            // „ÇØ„É™„Ç¢Ëâ≤„ÇíÊòé„Çã„ÇÅ„Å´Ë®≠ÂÆö„Åó„Å¶ÊÆãÂÉè„ÇíÂà∂Âæ°
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            animationId = requestAnimationFrame(animate);
        }

        function toggleRadar() {
            const controls = document.getElementById('radar-controls');

            if (radarLayer && map.hasLayer(radarLayer)) {
                // „É¨„Éº„ÉÄ„Éº„ÇíÈùûË°®Á§∫
                map.removeLayer(radarLayer);
                controls.style.display = 'none';
                stopRadarPlay();
            } else {
                // „É¨„Éº„ÉÄ„Éº„ÇíË°®Á§∫
                if (radarFrames.length === 0) {
                    addRadarLayer();
                } else {
                    updateRadarFrame(currentFrameIndex);
                    controls.style.display = 'block';
                }
            }
        }

        function toggleRadarPlay() {
            const playBtn = document.getElementById('play-btn');

            if (isRadarPlaying) {
                stopRadarPlay();
                playBtn.innerText = '‚ñ∂Ô∏è';
            } else {
                startRadarPlay();
                playBtn.innerText = '‚è∏Ô∏è';
            }
        }

        function startRadarPlay() {
            isRadarPlaying = true;
            radarPlayInterval = setInterval(() => {
                currentFrameIndex = (currentFrameIndex + 1) % radarFrames.length;
                document.getElementById('radar-slider').value = currentFrameIndex;
                updateRadarFrame(currentFrameIndex);
            }, 500); // 500ms„Åî„Å®„Å´„Éï„É¨„Éº„É†Êõ¥Êñ∞
        }

        function stopRadarPlay() {
            isRadarPlaying = false;
            if (radarPlayInterval) {
                clearInterval(radarPlayInterval);
                radarPlayInterval = null;
            }
        }

        function startSunCountdown() {
            // Êó¢Â≠ò„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´„Çí„ÇØ„É™„Ç¢
            if (sunCountdownInterval) {
                clearInterval(sunCountdownInterval);
            }

            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
            function updateCountdown() {
                const now = new Date();
                let targetTime, prefix, emoji;

                // ÁèæÂú®ÊôÇÂàª„Å®Êó•„ÅÆÂá∫/Êó•„ÅÆÂÖ•„Çä„ÇíÊØîËºÉ
                if (now < sunriseTime) {
                    // Êó•„ÅÆÂá∫Ââç ‚Üí Êó•„ÅÆÂá∫„Åæ„Åß
                    targetTime = sunriseTime;
                    prefix = 'üåÖ Êó•„ÅÆÂá∫„Åæ„Åß';
                } else if (now < sunsetTime) {
                    // Êó•‰∏≠ ‚Üí Êó•„ÅÆÂÖ•„Çä„Åæ„Åß
                    targetTime = sunsetTime;
                    prefix = 'üåá Êó•„ÅÆÂÖ•„Çä„Åæ„Åß';
                } else {
                    // Êó•Ê≤°Âæå ‚Üí ÊòéÊó•„ÅÆÊó•„ÅÆÂá∫„Åæ„Åß
                    targetTime = tomorrowSunriseTime;
                    prefix = 'üåÖ Êó•„ÅÆÂá∫„Åæ„Åß';
                }

                // ÊÆã„ÇäÊôÇÈñì„ÇíË®àÁÆó
                const diff = targetTime - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                document.getElementById('sun-countdown').innerText = `${prefix} „ÅÇ„Å® ${hours}ÊôÇÈñì${minutes}ÂàÜ`;
            }

            // ÂàùÂõûÂÆüË°å
            updateCountdown();

            // 1ÂàÜ„Åî„Å®„Å´Êõ¥Êñ∞
            sunCountdownInterval = setInterval(updateCountdown, 60000);
        }

        function drawHourlyChart(data) {
            const canvas = document.getElementById('hourly-chart');
            const ctx = canvas.getContext('2d');

            // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíÁ†¥Ê£Ñ
            if (hourlyChart) {
                hourlyChart.destroy();
            }

            // Ê¨°„ÅÆ24ÊôÇÈñì„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
            const temps = data.hourly.temperature_2m.slice(0, 24);
            const precips = data.hourly.precipitation_probability.slice(0, 24);

            // ÊôÇÂàª„É©„Éô„É´„ÇíÁîüÊàê
            const now = new Date();
            const labels = Array.from({ length: 24 }, (_, i) => {
                const futureTime = new Date(now.getTime() + i * 60 * 60 * 1000);
                const hour = futureTime.getHours();
                return `${hour.toString().padStart(2, '0')}:00`;
            });

            // Chart.js„Åß„Ç∞„É©„Éï„Çí‰ΩúÊàê
            hourlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'ÈôçÊ∞¥Á¢∫Áéá',
                            data: precips,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 0.5)',
                            borderWidth: 1,
                            yAxisID: 'y1',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'Ê∞óÊ∏©',
                            data: temps,
                            borderColor: 'rgba(251, 146, 60, 1)',
                            backgroundColor: 'rgba(251, 146, 60, 0.1)',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(251, 146, 60, 1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'rgba(100, 116, 139, 0.9)',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: 'rgba(30, 41, 59, 1)',
                            bodyColor: 'rgba(30, 41, 59, 1)',
                            borderColor: 'rgba(226, 232, 240, 1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += Math.round(context.parsed.y) + '¬∞C';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(100, 116, 139, 0.7)',
                                font: {
                                    size: 10,
                                    family: 'Inter, sans-serif'
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Ê∞óÊ∏© (¬∞C)',
                                color: 'rgba(251, 146, 60, 0.9)',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(100, 116, 139, 0.7)',
                                font: {
                                    size: 10,
                                    family: 'Inter, sans-serif'
                                },
                                callback: function(value) {
                                    return Math.round(value) + '¬∞';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'ÈôçÊ∞¥Á¢∫Áéá (%)',
                                color: 'rgba(59, 130, 246, 0.9)',
                                font: {
                                    size: 11,
                                    family: 'Inter, sans-serif'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(100, 116, 139, 0.7)',
                                font: {
                                    size: 10,
                                    family: 'Inter, sans-serif'
                                },
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
