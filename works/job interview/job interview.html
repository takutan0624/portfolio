<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšœå®³è€…é›‡ç”¨ç‰¹åŒ– é¢æ¥ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-[100dvh] h-[100dvh] flex flex-col overflow-hidden">

    <!-- 1. ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white px-4 py-3 flex justify-between items-center shadow-sm z-30 flex-shrink-0 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="bg-emerald-100 p-1.5 rounded-lg w-8 h-8 flex items-center justify-center flex-shrink-0" id="headerIcon"></div>
            <div>
                <h1 class="font-bold text-lg leading-none text-slate-800">é¢æ¥ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼AI</h1>
                <p class="text-[10px] font-bold text-emerald-600 mt-1 tracking-wide">éšœå®³è€…é›‡ç”¨ç‰¹åŒ– / å°±åŠ´ç§»è¡Œæ”¯æ´</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="app.clearHistory()" class="p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 rounded-full transition-colors" title="ãƒªã‚»ãƒƒãƒˆ">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
            <button onclick="app.openSettings()" class="p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 rounded-full transition-colors" title="è¨­å®š">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- 2. ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¿ãƒ– -->
    <div class="bg-white flex border-b border-slate-200 flex-shrink-0 overflow-x-auto sticky top-[56px] z-20" id="modeTabs"></div>

    <!-- 3. ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 scroll-smooth pb-6 relative overscroll-contain">
        <div class="flex justify-center sticky top-0 z-0 mb-4">
            <div class="bg-white/90 backdrop-blur border border-slate-200 px-4 py-1.5 rounded-full text-xs text-slate-500 flex items-center gap-2 shadow-sm">
                <i data-lucide="info" class="w-3 h-3"></i>
                <span id="modeDescription">åŸºæœ¬ã®å—ã‘ç­”ãˆã‚’ç·´ç¿’ã—ã¾ã™</span>
            </div>
        </div>

        <div id="messageList" class="space-y-4"></div>

        <div id="loadingIndicator" class="hidden flex justify-start w-full fade-in">
            <div class="flex max-w-[80%] gap-2">
                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin text-slate-400"></i>
                </div>
                <div class="bg-white px-4 py-3 rounded-2xl rounded-tl-none border border-slate-200 shadow-sm flex items-center gap-1 h-10">
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            </div>
        </div>
        
        <div class="h-16"></div> 
    </div>

    <!-- 4. å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="w-full bg-white border-t border-slate-200 p-4 pb-[calc(1.5rem+env(safe-area-inset-bottom))] z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex-shrink-0">
        <div class="max-w-4xl mx-auto relative flex items-end gap-2">
            <textarea id="userInput" 
                placeholder="å›ç­”ã‚’å…¥åŠ›... (Shift+Enterã§æ”¹è¡Œ)" 
                class="w-full p-3 pr-12 bg-slate-50 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none h-14 max-h-32 transition-all"
                rows="1"></textarea>
            <button id="sendBtn" onclick="app.sendMessage()" disabled
                class="absolute right-2 bottom-2 p-2 rounded-lg transition-colors bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="send" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- 5. è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col transform transition-transform scale-95">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-500"></i> è¨­å®š <span id="authStatus" class="text-xs font-normal ml-2 px-2 py-0.5 rounded bg-slate-100 text-slate-500">æœªæ¥ç¶š</span>
                </h2>
                <button onclick="app.closeSettings()" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="overflow-y-auto p-0">
                <div class="p-6 space-y-6">
                    <!-- Firebaseè¨­å®šè­¦å‘Š -->
                    <div id="firebaseWarning" class="hidden bg-amber-50 p-4 rounded-lg border border-amber-200 text-amber-800 text-sm mb-4">
                        <strong>âš ï¸ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼</strong><br>
                        <span id="firebaseErrorMessage">è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>
                    </div>

                    <div class="flex items-center gap-2 text-emerald-700 mb-2">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <h3 class="font-bold">åˆ©ç”¨è€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                    </div>
                    <p class="text-xs text-slate-500 bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                        ã“ã“ã«è‡ªåˆ†ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãŠãã¨ã€AIãŒãã‚Œã‚’è¸ã¾ãˆã¦è³ªå•ã—ã¦ãã‚Œã¾ã™ã€‚å†…å®¹ã¯è‡ªç”±ã«å¤‰æ›´ã§ãã¾ã™ã€‚
                    </p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ãŠåå‰</label>
                            <input type="text" id="profName" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">éšœå®³ãƒ»ç‰¹æ€§ï¼ˆAIã¸ã®å…±æœ‰äº‹é …ï¼‰</label>
                            <textarea id="profDiagnosis" placeholder="ä¾‹ï¼šã†ã¤ç—…ã€‚åˆå‰ä¸­ã®ä½“èª¿å¤‰åŒ–ãŒå¤§ãã„ã€‚" class="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">å¸Œæœ›ã™ã‚‹é…æ…®</label>
                            <textarea id="profAccommodations" placeholder="ä¾‹ï¼šé€šé™¢ã®ãŸã‚ã®ä¼‘æš‡ã€‚æŒ‡ç¤ºã¯ãƒ†ã‚­ã‚¹ãƒˆã§ã€‚" class="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none"></textarea>
                        </div>
                        <button onclick="app.saveProfile()" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold hover:bg-emerald-700 shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="save" class="w-4 h-4"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜
                        </button>
                    </div>
                </div>
                
                <!-- ç®¡ç†è€…ã‚¨ãƒªã‚¢ -->
                <div class="bg-slate-100 p-6 border-t border-slate-200" id="adminSection">
                    <div class="flex items-center gap-2 text-slate-700 mb-4 justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="shield" class="w-5 h-5"></i>
                            <h3 class="font-bold">ç®¡ç†è€…è¨­å®šï¼ˆAPIã‚­ãƒ¼ï¼‰</h3>
                        </div>
                        <button id="adminLogoutBtn" onclick="app.logoutAdmin()" class="hidden text-xs text-red-500 underline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>

                    <!-- 1. æœªãƒ­ã‚°ã‚¤ãƒ³ -->
                    <div id="adminLocked" class="space-y-3">
                        <p class="text-xs text-slate-500">ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€äº‹æ¥­æ‰€å…¨ä½“ã®APIã‚­ãƒ¼è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>
                        <!-- ã“ã“ã«ãƒ’ãƒ³ãƒˆã‚’è¿½åŠ  -->
                        <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 border border-blue-100">
                            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong><br>
                            ãƒ­ã‚°ã‚¤ãƒ³ã«ã¯ <strong>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</strong> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
                            (Authentication &gt; Users &gt; ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ )
                        </div>
                        <form onsubmit="event.preventDefault(); app.loginAdmin();" class="space-y-2">
                            <input type="email" id="adminEmail" placeholder="ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <input type="password" id="adminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <button type="submit" class="w-full bg-slate-700 text-white py-2 rounded-lg text-sm font-bold hover:bg-slate-600">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </form>
                        <p id="loginError" class="text-red-500 text-xs font-bold hidden"></p>
                    </div>

                    <!-- 2. ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ -->
                    <div id="adminUnlocked" class="space-y-4 hidden fade-in">
                        <div class="bg-white p-4 rounded-lg border border-emerald-200 space-y-4 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                            <p class="text-xs text-emerald-700 font-bold">ç®¡ç†è€…æ¨©é™ã§ç·¨é›†ä¸­</p>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Groq API Key (å…±æœ‰è¨­å®š)</label>
                                <input type="password" id="apiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" class="w-full p-2 border border-slate-300 rounded font-mono text-xs">
                            </div>
                            <button id="saveApiKeyBtn" onclick="app.saveAdminSettings()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition-colors">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Modular) - Version 11.2.0 (Stable) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";

        // ==========================================
        // ã€é‡è¦ã€‘ã“ã“ã«ã‚ãªãŸã®Firebaseè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBA6tvYA4IMl2fxYXrzQtB66DVs_IICbGs",
            authDomain: "jobinterview-c8055.firebaseapp.com",
            projectId: "jobinterview-c8055",
            storageBucket: "jobinterview-c8055.firebasestorage.app",
            messagingSenderId: "649656476488",
            appId: "1:649656476488:web:a37960764f9c169cb4097d",
            measurementId: "G-656YN92YLP"
        };

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        let db, auth, appInstance;
        let isFirebaseReady = false;

        try {
            const app = initializeApp(firebaseConfig);
            if (firebaseConfig.measurementId) {
                const analytics = getAnalytics(app);
            }
            db = getFirestore(app);
            auth = getAuth(app);
            isFirebaseReady = true;
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        window.app = {
            sendMessage: () => instance.sendMessage(),
            changeMode: (id) => instance.changeMode(id),
            clearHistory: () => instance.clearHistory(),
            openSettings: () => instance.openSettings(),
            closeSettings: () => instance.closeSettings(),
            saveProfile: () => instance.saveProfile(),
            loginAdmin: () => instance.loginAdmin(),
            logoutAdmin: () => instance.logoutAdmin(),
            saveAdminSettings: () => instance.saveAdminSettings(),
        };

        class InterviewPartnerApp {
            constructor() {
                this.state = {
                    messages: [],
                    mode: 'mock',
                    isLoading: false,
                    apiKey: '', 
                    userProfile: { name: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', diagnosis: '', strengths: '', accommodations: '' },
                    currentUser: null,
                    isAdmin: false
                };

                this.elements = {
                    chatContainer: document.getElementById('chatContainer'),
                    messageList: document.getElementById('messageList'),
                    userInput: document.getElementById('userInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    modeTabs: document.getElementById('modeTabs'),
                    modeDescription: document.getElementById('modeDescription'),
                    settingsModal: document.getElementById('settingsModal'),
                    headerIcon: document.getElementById('headerIcon'),
                    // Settings
                    profName: document.getElementById('profName'),
                    profDiagnosis: document.getElementById('profDiagnosis'),
                    profAccommodations: document.getElementById('profAccommodations'),
                    apiKey: document.getElementById('apiKey'),
                    adminLocked: document.getElementById('adminLocked'),
                    adminUnlocked: document.getElementById('adminUnlocked'),
                    adminEmail: document.getElementById('adminEmail'),
                    adminPassword: document.getElementById('adminPassword'),
                    loginError: document.getElementById('loginError'),
                    authStatus: document.getElementById('authStatus'),
                    adminLogoutBtn: document.getElementById('adminLogoutBtn'),
                    firebaseWarning: document.getElementById('firebaseWarning'),
                    firebaseErrorMessage: document.getElementById('firebaseErrorMessage'),
                    saveApiKeyBtn: document.getElementById('saveApiKeyBtn')
                };

                this.modes = [
                    { id: 'mock', label: 'åŸºæœ¬ã‚³ãƒ¼ã‚¹', icon: 'list-checks', color: 'text-blue-600', desc: 'è‡ªå·±ç´¹ä»‹â†’éšœå®³ç‰¹æ€§â†’é…æ…®â†’å¼·ã¿â†’å¿—æœ›å‹•æ©Ÿã®é †ã§é€²ã¿ã¾ã™' },
                    { id: 'accommodation', label: 'é…æ…®ç›¸è«‡', icon: 'heart', color: 'text-emerald-600', desc: 'ä½“èª¿ã‚„é…æ…®äº‹é …ã‚’æ·±æ˜ã‚Šã—ã¾ã™' },
                    { id: 'translate', label: 'æœ¬éŸ³ç¿»è¨³', icon: 'sparkles', color: 'text-amber-500', desc: 'ä¸å®‰ã‚„ç©ºç™½æœŸé–“ã‚’ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å¤‰æ›' },
                    { id: 'reverse', label: 'é€†è³ªå•', icon: 'help-circle', color: 'text-purple-600', desc: 'ä¼æ¥­ã¸ã®é€†è³ªå•ã‚’ä½œã‚Šã¾ã™' }
                ];
                
                this.cuteRobotSvg = `
                <svg viewBox="0 0 100 100" class="w-full h-full text-emerald-600 fill-current">
                    <line x1="50" y1="15" x2="50" y2="25" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="50" cy="12" r="6" fill="currentColor"/>
                    <rect x="20" y="25" width="60" height="50" rx="14" fill="white" stroke="currentColor" stroke-width="4"/>
                    <rect x="12" y="42" width="8" height="16" rx="2" fill="currentColor"/>
                    <rect x="80" y="42" width="8" height="16" rx="2" fill="currentColor"/>
                    <circle cx="38" cy="45" r="5" fill="currentColor"/>
                    <circle cx="62" cy="45" r="5" fill="currentColor"/>
                    <path d="M 40 60 Q 50 68 60 60" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="32" cy="55" r="3" fill="#fbbf24" opacity="0.6"/>
                    <circle cx="68" cy="55" r="3" fill="#fbbf24" opacity="0.6"/>
                </svg>
                `;

                this.init();
            }

            async init() {
                this.renderTabs();
                this.elements.headerIcon.innerHTML = this.cuteRobotSvg.replace('text-emerald-600', 'text-emerald-600');
                this.elements.userInput.addEventListener('input', () => this.updateSendButton());
                this.elements.userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                lucide.createIcons();

                if (isFirebaseReady) {
                    this.initFirebaseLogic();
                } else {
                    this.showFirebaseWarning("Firebaseã®è¨­å®šã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™ã€‚");
                    this.fallbackToLocal();
                }
            }

            initFirebaseLogic() {
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth State Changed:", user ? (user.isAnonymous ? "Anonymous" : "User: " + user.email) : "No User");
                    
                    if (user) {
                        this.state.currentUser = user;
                        this.elements.authStatus.textContent = "æ¥ç¶šä¸­";
                        this.elements.authStatus.className = "text-xs font-normal ml-2 px-2 py-0.5 rounded bg-emerald-100 text-emerald-600";
                        this.elements.firebaseWarning.classList.add('hidden'); 

                        // ç®¡ç†è€…åˆ¤å®š
                        if (!user.isAnonymous) {
                            console.log("Admin User Detected");
                            this.state.isAdmin = true;
                            this.renderAdminSection();
                        } else {
                            this.state.isAdmin = false;
                            this.renderAdminSection();
                        }

                        // Firestoreã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                        try {
                            onSnapshot(doc(db, "system", "config"), (snapshot) => {
                                if (snapshot.exists()) {
                                    const data = snapshot.data();
                                    if(data && data.groqApiKey) {
                                        this.state.apiKey = data.groqApiKey;
                                        console.log("API Key loaded from Firestore");
                                    }
                                }
                            }, (error) => {
                                // æ¨©é™ã‚¨ãƒ©ãƒ¼ãªã©ã¯ãƒ­ã‚°ã«å‡ºã™ãŒã€ã‚¢ãƒ—ãƒªã¯æ­¢ã‚ãªã„
                                console.log("Config read error (ignore if not admin):", error.code);
                            });

                            const userDocRef = doc(db, "users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            
                            if (userDoc.exists()) {
                                this.state.userProfile = userDoc.data();
                                this.loadProfileToUI();
                            } else {
                                const localProfile = localStorage.getItem('user_profile');
                                if(localProfile) {
                                    try {
                                        this.state.userProfile = JSON.parse(localProfile);
                                        await setDoc(userDocRef, this.state.userProfile, { merge: true });
                                    } catch(e) {
                                        console.log("Profile migration error:", e);
                                    }
                                }
                            }
                        } catch (e) {
                            console.error("Firestore Data Load Error:", e);
                        }

                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anon Auth Error", error);
                            if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                                this.showFirebaseWarning("Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã€ŒAuthenticationã€>ã€ŒSign-in methodã€>ã€ŒåŒ¿å(Anonymous)ã€ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚");
                            } else {
                                this.showFirebaseWarning(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                            }
                            this.fallbackToLocal();
                        });
                    }
                });
                
                this.addSystemMessage(this.getInitialGreeting('mock'));
            }

            showFirebaseWarning(message) {
                this.elements.firebaseErrorMessage.textContent = message;
                this.elements.firebaseWarning.classList.remove('hidden');
            }

            fallbackToLocal() {
                this.state.apiKey = localStorage.getItem('groq_api_key') || '';
                const savedProfile = localStorage.getItem('user_profile');
                if (savedProfile) this.state.userProfile = JSON.parse(savedProfile);
                this.loadProfileToUI();
                if (this.state.messages.length === 0) {
                    this.addSystemMessage(this.getInitialGreeting('mock'));
                }
            }

            async loginAdmin() {
                if(!isFirebaseReady) return alert("FirebaseãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                const email = this.elements.adminEmail.value;
                const password = this.elements.adminPassword.value;
                this.elements.loginError.classList.add('hidden');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    this.elements.adminEmail.value = '';
                    this.elements.adminPassword.value = '';
                } catch (error) {
                    this.elements.loginError.textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message;
                    this.elements.loginError.classList.remove('hidden');
                }
            }

            async logoutAdmin() {
                await signOut(auth);
                this.state.isAdmin = false;
                this.renderAdminSection();
            }

            async saveAdminSettings() {
                // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                console.log("saveAdminSettings called");

                if(!isFirebaseReady) {
                    alert("FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                if(!this.state.isAdmin) {
                    alert("ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                
                const newKey = this.elements.apiKey.value.trim();
                if (!newKey) {
                    alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹å¤‰æ›´ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
                const btn = this.elements.saveApiKeyBtn;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = "ä¿å­˜ä¸­...";
                btn.classList.add("opacity-50");

                try {
                    await setDoc(doc(db, "system", "config"), { groqApiKey: newKey }, { merge: true });
                    alert("âœ… ã‚·ã‚¹ãƒ†ãƒ è¨­å®š(APIã‚­ãƒ¼)ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸã€‚\nä»–ã®ç«¯æœ«ã§ã‚‚ã“ã®ã‚­ãƒ¼ãŒè‡ªå‹•çš„ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚");
                } catch (e) {
                    console.error(e);
                    
                    let msg = `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                    if (e.code === 'permission-denied') {
                        msg = "ã€æ¨©é™ã‚¨ãƒ©ãƒ¼ã€‘\nFirestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šæ›¸ãè¾¼ã¿ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\n\nFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« > Firestore Database > ãƒ«ãƒ¼ãƒ« ã‚¿ãƒ–ã‚’é–‹ãã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„:\n\nallow read, write: if true;";
                    }
                    
                    alert(msg);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.classList.remove("opacity-50");
                }
            }

            renderAdminSection() {
                if (this.state.isAdmin) {
                    this.elements.adminLocked.classList.add('hidden');
                    this.elements.adminUnlocked.classList.remove('hidden');
                    this.elements.adminLogoutBtn.classList.remove('hidden');
                    this.elements.apiKey.value = this.state.apiKey;
                } else {
                    this.elements.adminLocked.classList.remove('hidden');
                    this.elements.adminUnlocked.classList.add('hidden');
                    this.elements.adminLogoutBtn.classList.add('hidden');
                }
            }

            renderTabs() {
                this.elements.modeTabs.innerHTML = this.modes.map(m => `
                    <button onclick="app.changeMode('${m.id}')" 
                        class="flex-1 min-w-[80px] py-3 px-1 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-[10px] sm:text-sm font-bold transition-all border-b-2 
                        ${this.state.mode === m.id ? `${m.color} border-current bg-slate-50` : 'text-slate-400 border-transparent hover:text-slate-600'}">
                        <i data-lucide="${m.icon}" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        <span class="whitespace-nowrap">${m.label}</span>
                    </button>
                `).join('');
                lucide.createIcons();
            }

            addMessageToDOM(role, text) {
                const div = document.createElement('div');
                div.className = `flex w-full ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
                const currentModeConfig = this.modes.find(m => m.id === this.state.mode);
                let iconHtml = '', iconBg = '';

                if (role === 'user') {
                    iconBg = 'bg-slate-200 text-slate-500';
                    iconHtml = `<i data-lucide="user" class="w-5 h-5"></i>`;
                } else {
                    const colorClass = currentModeConfig.color; 
                    const bgClass = `bg-${colorClass.split('-')[1]}-100`; 
                    iconBg = `${bgClass}`;
                    iconHtml = this.cuteRobotSvg.replace('text-emerald-600', colorClass);
                }

                const parsedText = role === 'assistant' ? marked.parse(text) : text.replace(/\n/g, '<br>');

                div.innerHTML = `
                    <div class="flex max-w-[90%] sm:max-w-[80%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} gap-2">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mt-1 overflow-hidden p-1 ${iconBg}">
                            ${iconHtml}
                        </div>
                        <div class="p-4 rounded-2xl text-sm sm:text-base leading-relaxed shadow-sm overflow-hidden prose prose-sm max-w-none
                            ${role === 'user' ? 'bg-slate-800 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'}">
                            ${parsedText}
                        </div>
                    </div>
                `;
                this.elements.messageList.appendChild(div);
                this.scrollToBottom();
                if (role === 'user') lucide.createIcons(); 
            }

            addSystemMessage(text) {
                this.state.messages.push({ role: 'assistant', content: text });
                this.addMessageToDOM('assistant', text);
            }

            scrollToBottom() {
                const container = this.elements.chatContainer;
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }

            updateSendButton() {
                const text = this.elements.userInput.value.trim();
                const btn = this.elements.sendBtn;
                if (text && !this.state.isLoading) {
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btn.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                } else {
                    btn.disabled = true;
                    btn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btn.classList.remove('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                }
            }

            changeMode(newMode) {
                if (this.state.mode === newMode) return;
                this.state.mode = newMode;
                this.state.messages = [];
                this.elements.messageList.innerHTML = '';
                this.renderTabs();
                const modeConfig = this.modes.find(m => m.id === newMode);
                this.elements.modeDescription.textContent = modeConfig.desc;
                this.addSystemMessage(this.getInitialGreeting(newMode));
            }

            async sendMessage() {
                const text = this.elements.userInput.value.trim();
                if (!text || !this.state.apiKey) {
                    if(!this.state.apiKey) {
                        alert('ã€æº–å‚™ä¸­ã€‘\nAPIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ï¼ˆã‚ãªãŸï¼‰ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                        this.openSettings();
                    }
                    return;
                }

                this.state.messages.push({ role: 'user', content: text });
                this.addMessageToDOM('user', text);
                this.elements.userInput.value = '';
                this.updateSendButton();
                this.state.isLoading = true;
                this.elements.loadingIndicator.classList.remove('hidden');
                this.scrollToBottom();

                try {
                    // Groqãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
                    const prompt = this.generateSystemPrompt();
                    const history = this.state.messages.map(m => ({
                        role: m.role === 'user' ? 'user' : 'assistant',
                        content: m.content
                    }));

                    // Groq OpenAIäº’æ›API
                    const modelId = "llama-3.3-70b-versatile";
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelId,
                            messages: [
                                { role: "system", content: prompt },
                                ...history
                            ],
                            temperature: 0.7,
                            max_completion_tokens: 1000
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);

                    const botResponse = data.choices[0].message.content;
                    this.state.isLoading = false;
                    this.elements.loadingIndicator.classList.add('hidden');
                    this.addSystemMessage(botResponse);

                } catch (error) {
                    console.error(error);
                    this.state.isLoading = false;
                    this.elements.loadingIndicator.classList.add('hidden');
                    
                    let errorMsg = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                    if (error.message.includes('Quota exceeded') || error.message.includes('429')) {
                        errorMsg = "âš ï¸ **åˆ©ç”¨åˆ¶é™ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿ï¼‰ã‚’è¶…éã—ã¾ã—ãŸ**\n\nGoogle Gemini APIã®ç„¡æ–™æ ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ï¼ˆ1åˆ†ã€œæ•°åˆ†ç¨‹åº¦ï¼‰ã‚’ç©ºã‘ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚\nâ€»çŸ­æ™‚é–“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã™ãã‚‹ã¨ç™ºç”Ÿã—ã¾ã™ã€‚";
                    }
                    
                    this.addSystemMessage(errorMsg);
                }
            }

            clearHistory() {
                if(confirm('ä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.state.messages = [];
                    this.elements.messageList.innerHTML = '';
                    this.addSystemMessage(this.getInitialGreeting(this.state.mode));
                }
            }

            openSettings() {
                this.loadProfileToUI();
                this.elements.settingsModal.classList.remove('hidden');
                void this.elements.settingsModal.offsetWidth;
                this.elements.settingsModal.classList.remove('opacity-0');
                this.elements.settingsModal.children[0].classList.remove('scale-95');
            }

            closeSettings() {
                this.elements.settingsModal.classList.add('opacity-0');
                this.elements.settingsModal.children[0].classList.add('scale-95');
                setTimeout(() => {
                    this.elements.settingsModal.classList.add('hidden');
                }, 200);
            }

            loadProfileToUI() {
                this.elements.profName.value = this.state.userProfile.name;
                this.elements.profDiagnosis.value = this.state.userProfile.diagnosis;
                this.elements.profAccommodations.value = this.state.userProfile.accommodations;
            }

            async saveProfile() {
                this.state.userProfile = {
                    name: this.elements.profName.value,
                    diagnosis: this.elements.profDiagnosis.value,
                    strengths: '', 
                    accommodations: this.elements.profAccommodations.value
                };
                
                if(isFirebaseReady && this.state.currentUser) {
                    try {
                        await setDoc(doc(db, "users", this.state.currentUser.uid), this.state.userProfile, { merge: true });
                        alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ');
                    } catch(e) {
                        console.error(e);
                        let msg = `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                        if (e.code === 'permission-denied') {
                            msg = "ã€æ¨©é™ã‚¨ãƒ©ãƒ¼ã€‘\nFirestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                        }
                        alert(msg);
                    }
                } else {
                    localStorage.setItem('user_profile', JSON.stringify(this.state.userProfile));
                    alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸ');
                }
            }

            getInitialGreeting(mode) {
                const map = {
                    mock: 'ã€åŸºæœ¬ã®æ¨¡æ“¬é¢æ¥ã‚³ãƒ¼ã‚¹ã€‘\néšœå®³è€…é›‡ç”¨ã§ã‚ˆãèã‹ã‚Œã‚‹5ã¤ã®è³ªå•ï¼ˆè‡ªå·±ç´¹ä»‹ã€éšœå®³ç‰¹æ€§ã€é…æ…®äº‹é …ã€å¼·ã¿ã€å¿—æœ›å‹•æ©Ÿï¼‰ã‚’é †ç•ªã«è¡Œã„ã¾ã™ã€‚\nã¾ãšã¯ã€Œè‡ªå·±ç´¹ä»‹ã¨è·å‹™çµŒæ­´ã€ã‚’ãŠé¡˜ã„ã§ãã¾ã™ã‹ï¼Ÿ',
                    accommodation: 'ã€é…æ…®ãƒ»å®šç€æ”¯æ´ã€‘\néšœå®³è€…é›‡ç”¨ã§é‡è¦–ã•ã‚Œã‚‹ã€Œé•·ãå®‰å®šã—ã¦åƒã‘ã‚‹ã‹ã€ã‚’ç¢ºèªã—ã¾ã™ã€‚ä½“èª¿ã‚„å¯¾å‡¦æ³•ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚',
                    translate: 'ã€æœ¬éŸ³ç¿»è¨³ã€‘\nã€ŒåƒããŸããªã„ã€ã€Œæ€–ã„ã€ãªã©ã®æœ¬éŸ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ã«å¤‰æ›ã—ã¾ã™ã€‚',
                    reverse: 'ã€é€†è³ªå•ä½œæˆã€‘\nã€Œæ®‹æ¥­ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ãªã©ã€ä¼æ¥­ã«èããŸã„ã“ã¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å¤±ç¤¼ã«ãªã‚‰ãªã„èãæ–¹ã‚’ææ¡ˆã—ã¾ã™ã€‚'
                };
                return map[mode] || 'ã“ã‚“ã«ã¡ã¯';
            }

            generateSystemPrompt() {
                const p = this.state.userProfile;
                const profileText = `[å¿œå‹Ÿè€…æƒ…å ±]\nåå‰:${p.name}\nç‰¹æ€§:${p.diagnosis}\né…æ…®:${p.accommodations}`;
                const base = `ã‚ãªãŸã¯éšœå®³è€…é›‡ç”¨ã®å°‚é–€å®¶AIã§ã™ã€‚\n${profileText}`;

                if (this.state.mode === 'translate') return `${base}\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæœ¬éŸ³ã‚’ã€é¢æ¥ã§ä½¿ãˆã‚‹èª å®Ÿã‹ã¤ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ã«å¤‰æ›ã—ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚ã€Œå…±æ„Ÿâ†’ææ¡ˆâ†’è§£èª¬ã€ã®é †ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
                if (this.state.mode === 'reverse') return `${base}\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œä¼æ¥­ã¸ã®ç‡ç›´ãªè³ªå•ã€ã‚’ã€æ„æ¬²çš„ã‹ã¤ä¸å¯§ã«èã“ãˆã‚‹ã€Œé€†è³ªå•ã€ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚`;
                if (this.state.mode === 'accommodation') return `${base}\nåˆç†çš„é…æ…®ã‚„ä½“èª¿ç®¡ç†ï¼ˆå°±åŠ´ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã®å†…å®¹ï¼‰ã«ã¤ã„ã¦æ·±ãå„ªã—ãè³ªå•ã—ã€å®šç€å¯èƒ½æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                
                return `${base}\n
                åŸºæœ¬ã®æ¨¡æ“¬é¢æ¥ã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã€è³ªå•ãƒªã‚¹ãƒˆã€‘ã®é †åºã«å¾“ã£ã¦ã€1ã¤ãšã¤è³ªå•ã—ã¦ãã ã•ã„ã€‚
                å¿…ãšå‰ã®è³ªå•ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰æ¬¡ã®è³ªå•ã¸é€²ã‚“ã§ãã ã•ã„ã€‚ä¸€åº¦ã«è¤‡æ•°ã®è³ªå•ã¯ã—ãªã„ã§ãã ã•ã„ã€‚

                ã€è³ªå•ãƒªã‚¹ãƒˆã€‘
                1. ã¾ãšã¯ç°¡å˜ã«ã€è‡ªå·±ç´¹ä»‹ã¨è·å‹™çµŒæ­´ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
                2. ã”è‡ªèº«ã®éšœå®³ç‰¹æ€§ã‚„ã€ä½“èª¿ç®¡ç†ã§æ°—ã‚’ã¤ã‘ã¦ã„ã‚‹ã“ã¨ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ï¼ˆä¸èª¿ã®ã‚µã‚¤ãƒ³ãªã©ï¼‰ã€‚
                3. æ¥­å‹™ã«ã‚ãŸã£ã¦ã€ä¼šç¤¾å´ã«é…æ…®ã—ã¦ã»ã—ã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
                4. ã”è‡ªèº«ã®å¼·ã¿ã‚„ã€ã“ã‚Œã¾ã§ã®çµŒé¨“ã§æ´»ã‹ã›ã‚‹ã‚¹ã‚­ãƒ«ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
                5. æœ€å¾Œã«ã€å½“ç¤¾ã‚’å¿—æœ›ã•ã‚ŒãŸç†ç”±ï¼ˆå¿—æœ›å‹•æ©Ÿï¼‰ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

                â€»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã«å¯¾ã—ã¦ã¯ã€ã¾ãšã€Œè‰¯ã„ç‚¹ã€ã‚’å…·ä½“çš„ã«è¤’ã‚ã¦ãã ã•ã„ã€‚ãã®ä¸Šã§ã€ã‚‚ã—æ”¹å–„ç‚¹ãŒã‚ã‚Œã°ã€Œã‚‚ã£ã¨ã“ã†ã™ã‚‹ã¨ä¼ã‚ã‚Šã‚„ã™ã„ã€ã¨å„ªã—ã1ç‚¹ã ã‘ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚
                ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å¾Œã€ã€Œã§ã¯æ¬¡ã®è³ªå•ã§ã™ã€ã¨ç¶šã‘ã¦ãã ã•ã„ã€‚`;
            }
        }

        const instance = new InterviewPartnerApp();
    </script>
</body>
</html>
