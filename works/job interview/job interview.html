<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>障害者雇用特化 面接パートナーAI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify (XSS対策) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .header-title::before { content: attr(data-label); }
        .header-subtitle::before { content: attr(data-label); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-[100dvh] h-[100dvh] flex flex-col">

    <!-- 1. ヘッダー -->
    <header class="bg-white px-4 py-3 flex justify-between items-center shadow-sm z-30 flex-shrink-0 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="bg-emerald-100 p-1.5 rounded-lg w-8 h-8 flex items-center justify-center flex-shrink-0" id="headerIcon"></div>
            <div>
                <h1 class="font-bold text-lg leading-none text-slate-800 header-title" data-label="面接パートナーAI" aria-label="面接パートナーAI"></h1>
                <p class="text-[10px] font-bold text-emerald-600 mt-1 tracking-wide header-subtitle" data-label="障害者雇用特化 / 就労移行支援" aria-label="障害者雇用特化 / 就労移行支援"></p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="app.clearHistory()" class="p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 rounded-full transition-colors" title="リセット">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
            <button onclick="app.openSettings()" class="p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 rounded-full transition-colors" title="設定">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- 2. モード選択タブ -->
    <div class="bg-white flex border-b border-slate-200 flex-shrink-0 overflow-x-auto sticky top-[56px] z-20" id="modeTabs"></div>

    <!-- 3. チャットエリア -->
    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 scroll-smooth pb-6 relative overscroll-contain">
        <div class="flex justify-center sticky top-0 z-0 mb-4">
            <div class="bg-white/90 backdrop-blur border border-slate-200 px-4 py-1.5 rounded-full text-xs text-slate-500 flex items-center gap-2 shadow-sm">
                <i data-lucide="info" class="w-3 h-3"></i>
                <span id="modeDescription">基本の受け答えを練習します</span>
            </div>
        </div>

        <div id="messageList" class="space-y-4"></div>

        <div id="loadingIndicator" class="hidden flex justify-start w-full fade-in">
            <div class="flex max-w-[80%] gap-2">
                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin text-slate-400"></i>
                </div>
                <div class="bg-white px-4 py-3 rounded-2xl rounded-tl-none border border-slate-200 shadow-sm flex items-center gap-1 h-10">
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            </div>
        </div>
        
        <div class="h-16"></div> 
    </div>

    <!-- 4. 入力エリア -->
    <div class="w-full bg-white border-t border-slate-200 p-4 pb-[calc(1.5rem+env(safe-area-inset-bottom))] z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex-shrink-0">
        <div class="max-w-4xl mx-auto relative flex items-end gap-2">
            <textarea id="userInput" 
                placeholder="回答を入力... (Enterで改行 / Ctrl+Enterで送信)" 
                class="w-full p-3 pr-12 bg-slate-50 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none h-14 max-h-32 transition-all"
                rows="1"></textarea>
            <button id="sendBtn" onclick="app.sendMessage()" disabled
                class="absolute right-2 bottom-2 p-2 rounded-lg transition-colors bg-slate-200 text-slate-400 cursor-not-allowed">
                <i data-lucide="send" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- 5. 設定モーダル -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col transform transition-transform scale-95">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-500"></i> 設定 <span id="authStatus" class="text-xs font-normal ml-2 px-2 py-0.5 rounded bg-slate-100 text-slate-500">未接続</span>
                </h2>
                <button onclick="app.closeSettings()" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="overflow-y-auto p-0">
                <div class="p-6 space-y-6">
                    <!-- Firebase設定警告 -->
                    <div id="firebaseWarning" class="hidden bg-amber-50 p-4 rounded-lg border border-amber-200 text-amber-800 text-sm mb-4">
                        <strong>⚠️ Firebase接続エラー</strong><br>
                        <span id="firebaseErrorMessage">設定を確認してください。</span>
                    </div>

                    <div class="flex items-center gap-2 text-emerald-700 mb-2">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <h3 class="font-bold">利用者プロフィール</h3>
                    </div>
                    <p class="text-xs text-slate-500 bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                        ここに自分の情報を入力しておくと、AIがそれを踏まえて質問してくれます。内容は自由に変更できます。
                    </p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">お名前</label>
                            <input type="text" id="profName" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">障害・特性（AIへの共有事項）</label>
                            <textarea id="profDiagnosis" placeholder="例：うつ病。午前中の体調変化が大きい。" class="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">希望する配慮</label>
                            <textarea id="profAccommodations" placeholder="例：通院のための休暇。指示はテキストで。" class="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none"></textarea>
                        </div>
                        <button onclick="app.saveProfile()" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold hover:bg-emerald-700 shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="save" class="w-4 h-4"></i> プロフィールを保存
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Modular) - Version 11.2.0 (Stable) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";

        // ==========================================
        // 【重要】ここにあなたのFirebase設定を貼り付けてください
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBA6tvYA4IMl2fxYXrzQtB66DVs_IICbGs",
            authDomain: "jobinterview-c8055.firebaseapp.com",
            projectId: "jobinterview-c8055",
            storageBucket: "jobinterview-c8055.firebasestorage.app",
            messagingSenderId: "649656476488",
            appId: "1:649656476488:web:a37960764f9c169cb4097d",
            measurementId: "G-656YN92YLP"
        };

        // Groq Proxy (Vercel API)
        const GROQ_PROXY_URL = "/api/groq";

        // --- アプリケーションロジック ---
        
        let db, auth, appInstance;
        let isFirebaseReady = false;

        try {
            const app = initializeApp(firebaseConfig);
            if (firebaseConfig.measurementId) {
                const analytics = getAnalytics(app);
            }
            db = getFirestore(app);
            auth = getAuth(app);
            isFirebaseReady = true;
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        window.app = {
            sendMessage: () => instance.sendMessage(),
            changeMode: (id) => instance.changeMode(id),
            clearHistory: () => instance.clearHistory(),
            openSettings: () => instance.openSettings(),
            closeSettings: () => instance.closeSettings(),
            saveProfile: () => instance.saveProfile(),
        };

        class InterviewPartnerApp {
            constructor() {
                this.state = {
                    messages: [],
                    messagesByMode: {},
                    mode: 'mock',
                    isLoading: false,
                    userProfile: { name: 'ユーザー', diagnosis: '', strengths: '', accommodations: '' },
                    currentUser: null,
                    isAuthReady: false
                };

                this.elements = {
                    chatContainer: document.getElementById('chatContainer'),
                    messageList: document.getElementById('messageList'),
                    userInput: document.getElementById('userInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    modeTabs: document.getElementById('modeTabs'),
                    modeDescription: document.getElementById('modeDescription'),
                    settingsModal: document.getElementById('settingsModal'),
                    headerIcon: document.getElementById('headerIcon'),
                    // Settings
                    profName: document.getElementById('profName'),
                    profDiagnosis: document.getElementById('profDiagnosis'),
                    profAccommodations: document.getElementById('profAccommodations'),
                    authStatus: document.getElementById('authStatus'),
                    firebaseWarning: document.getElementById('firebaseWarning'),
                    firebaseErrorMessage: document.getElementById('firebaseErrorMessage')
                };

                this.modeColor = {
                    mock: { text: 'text-blue-600', bg: 'bg-blue-100' },
                    accommodation: { text: 'text-emerald-600', bg: 'bg-emerald-100' },
                    translate: { text: 'text-amber-500', bg: 'bg-amber-100' },
                    reverse: { text: 'text-purple-600', bg: 'bg-purple-100' }
                };

                this.modes = [
                    { id: 'mock', label: '基本コース', icon: 'list-checks', desc: '自己紹介→障害特性→配慮→強み→志望動機の順で進みます' },
                    { id: 'accommodation', label: '配慮相談', icon: 'heart', desc: '体調や配慮事項を深掘りします' },
                    { id: 'translate', label: '本音翻訳', icon: 'sparkles', desc: '不安や空白期間をポジティブに変換' },
                    { id: 'reverse', label: '逆質問', icon: 'help-circle', desc: '企業への逆質問を作ります' }
                ];
                
                this.cuteRobotSvg = `
                <svg viewBox="0 0 100 100" class="w-full h-full text-emerald-600 fill-current">
                    <line x1="50" y1="15" x2="50" y2="25" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="50" cy="12" r="6" fill="currentColor"/>
                    <rect x="20" y="25" width="60" height="50" rx="14" fill="white" stroke="currentColor" stroke-width="4"/>
                    <rect x="12" y="42" width="8" height="16" rx="2" fill="currentColor"/>
                    <rect x="80" y="42" width="8" height="16" rx="2" fill="currentColor"/>
                    <circle cx="38" cy="45" r="5" fill="currentColor"/>
                    <circle cx="62" cy="45" r="5" fill="currentColor"/>
                    <path d="M 40 60 Q 50 68 60 60" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <circle cx="32" cy="55" r="3" fill="#fbbf24" opacity="0.6"/>
                    <circle cx="68" cy="55" r="3" fill="#fbbf24" opacity="0.6"/>
                </svg>
                `;

                this.init();
            }

            async init() {
                this.renderTabs();
                this.elements.headerIcon.innerHTML = this.cuteRobotSvg.replace('text-emerald-600', 'text-emerald-600');
                this.elements.userInput.addEventListener('input', () => this.updateSendButton());
                this.elements.userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                lucide.createIcons();

                if (isFirebaseReady) {
                    this.initFirebaseLogic();
                } else {
                    this.showFirebaseWarning("Firebaseの設定コードが無効です。");
                    this.fallbackToLocal();
                }
            }

            initFirebaseLogic() {
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth State Changed:", user ? (user.isAnonymous ? "Anonymous" : "User: " + user.email) : "No User");
                    
                    if (user) {
                        this.state.currentUser = user;
                        this.state.isAuthReady = true;
                        this.elements.authStatus.textContent = "接続中";
                        this.elements.authStatus.className = "text-xs font-normal ml-2 px-2 py-0.5 rounded bg-emerald-100 text-emerald-600";
                        this.elements.firebaseWarning.classList.add('hidden'); 
                        this.updateSendButton();

                        // Firestoreからのデータ読み込み
                        try {
                            const userDocRef = doc(db, "users", user.uid);
                            const userDoc = await getDoc(userDocRef);
                            
                            if (userDoc.exists()) {
                                this.state.userProfile = userDoc.data();
                                this.loadProfileToUI();
                            } else {
                                const localProfile = localStorage.getItem('user_profile');
                                if(localProfile) {
                                    try {
                                        this.state.userProfile = JSON.parse(localProfile);
                                        await setDoc(userDocRef, this.state.userProfile, { merge: true });
                                    } catch(e) {
                                        console.log("Profile migration error:", e);
                                    }
                                }
                            }
                        } catch (e) {
                            console.error("Firestore Data Load Error:", e);
                        }

                        if (this.state.messages.length === 0) {
                            this.addSystemMessage(this.getInitialGreeting(this.state.mode));
                        }

                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anon Auth Error", error);
                            if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                                this.showFirebaseWarning("Firebaseコンソールで「Authentication」>「Sign-in method」>「匿名(Anonymous)」を有効にしてください。");
                            } else {
                                this.showFirebaseWarning(`認証エラー: ${error.message}`);
                            }
                            this.fallbackToLocal();
                        });
                    }
                });
            }

            showFirebaseWarning(message) {
                this.elements.firebaseErrorMessage.textContent = message;
                this.elements.firebaseWarning.classList.remove('hidden');
            }

            fallbackToLocal() {
                const savedProfile = localStorage.getItem('user_profile');
                if (savedProfile) this.state.userProfile = JSON.parse(savedProfile);
                this.loadProfileToUI();
                if (this.state.messages.length === 0) {
                    this.addSystemMessage(this.getInitialGreeting('mock'));
                }
            }

            renderTabs() {
                this.elements.modeTabs.innerHTML = this.modes.map(m => `
                    <button onclick="app.changeMode('${m.id}')" 
                        class="flex-1 min-w-[80px] py-3 px-1 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-[10px] sm:text-sm font-bold transition-all border-b-2 
                        ${this.state.mode === m.id ? `${this.modeColor[m.id]?.text || 'text-emerald-600'} border-current bg-slate-50` : 'text-slate-400 border-transparent hover:text-slate-600'}">
                        <i data-lucide="${m.icon}" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                        <span class="whitespace-nowrap">${m.label}</span>
                    </button>
                `).join('');
                lucide.createIcons();
            }

            addMessageToDOM(role, text) {
                const div = document.createElement('div');
                div.className = `flex w-full ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
                let iconHtml = '', iconBg = '';

                if (role === 'user') {
                    iconBg = 'bg-slate-200 text-slate-500';
                    iconHtml = `<i data-lucide="user" class="w-5 h-5"></i>`;
                } else {
                    const modeColors = this.modeColor[this.state.mode] || { text: 'text-emerald-600', bg: 'bg-emerald-100' };
                    iconBg = modeColors.bg;
                    iconHtml = this.cuteRobotSvg.replace('text-emerald-600', modeColors.text);
                }

                let parsedText;
                if (role === 'assistant') {
                    const raw = marked.parse(text);
                    parsedText = DOMPurify.sanitize(raw, { USE_PROFILES: { html: true } });
                } else {
                    // ユーザー入力はHTML化しない（安全側）
                    parsedText = text
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/\n/g, "<br>");
                }

                div.innerHTML = `
                    <div class="flex max-w-[90%] sm:max-w-[80%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} gap-2">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mt-1 overflow-hidden p-1 ${iconBg}">
                            ${iconHtml}
                        </div>
                        <div class="p-4 rounded-2xl text-sm sm:text-base leading-relaxed shadow-sm overflow-hidden prose prose-sm max-w-none
                            ${role === 'user' ? 'bg-slate-800 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'}">
                            ${parsedText}
                        </div>
                    </div>
                `;
                this.elements.messageList.appendChild(div);
                this.scrollToBottom();
                if (role === 'user') lucide.createIcons(); 
            }

            addSystemMessage(text) {
                this.state.messages.push({ role: 'assistant', content: text });
                this.addMessageToDOM('assistant', text);
            }

            renderHistory() {
                this.elements.messageList.innerHTML = '';
                this.state.messages.forEach(m => {
                    this.addMessageToDOM(m.role, m.content);
                });
            }

            scrollToBottom() {
                const container = this.elements.chatContainer;
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }

            updateSendButton() {
                const text = this.elements.userInput.value.trim();
                const btn = this.elements.sendBtn;
                if (text && !this.state.isLoading && this.state.isAuthReady) {
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btn.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                } else {
                    btn.disabled = true;
                    btn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btn.classList.remove('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                }
            }

            changeMode(newMode) {
                if (this.state.mode === newMode) return;
                this.state.messagesByMode[this.state.mode] = this.state.messages;
                this.state.mode = newMode;
                this.state.messages = this.state.messagesByMode[newMode] || [];
                this.renderTabs();
                const modeConfig = this.modes.find(m => m.id === newMode);
                this.elements.modeDescription.textContent = modeConfig.desc;
                this.renderHistory();
                if (this.state.messages.length === 0) {
                    this.addSystemMessage(this.getInitialGreeting(newMode));
                }
            }

            async sendMessage() {
                const text = this.elements.userInput.value.trim();
                if (!text) return;

                if (!GROQ_PROXY_URL || GROQ_PROXY_URL.includes("<YOUR_REGION>") || GROQ_PROXY_URL.includes("<YOUR_PROJECT>")) {
                    alert("GROQ_PROXY_URL が未設定です。FunctionsのURLに置き換えてください。");
                    return;
                }

                const user = auth.currentUser;
                if (!user) {
                    throw new Error("認証中です。数秒待ってから再試行してください。");
                }

                this.state.messages.push({ role: 'user', content: text });
                this.addMessageToDOM('user', text);
                this.elements.userInput.value = '';
                this.updateSendButton();
                this.state.isLoading = true;
                this.elements.loadingIndicator.classList.remove('hidden');
                this.scrollToBottom();

                try {
                    // Groqモデルを使用
                    const prompt = this.generateSystemPrompt();
                    const history = this.state.messages.map(m => ({
                        role: m.role === 'user' ? 'user' : 'assistant',
                        content: m.content
                    }));

                    // Groq Proxy (Cloud Functions) 経由
                    const modelId = "llama-3.3-70b-versatile";
                    const idToken = await user.getIdToken();
                    if (!idToken) {
                        throw new Error("認証トークンが取得できませんでした。ログイン状態を確認してください。");
                    }

                    const response = await fetch(GROQ_PROXY_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            model: modelId,
                            messages: [
                                { role: "system", content: prompt },
                                ...history
                            ],
                            temperature: 0.7,
                            max_completion_tokens: 1000
                        })
                    });

                    // まずHTTPを確認
                    if (!response.ok) {
                        const text = await response.text().catch(() => "");
                        const retryAfter = response.headers.get("retry-after");
                        const status = response.status;

                        if (status === 401) {
                            throw new Error("認証エラー（401）: APIキーが無効、または失効しています。");
                        }
                        if (status === 429) {
                            throw new Error(`レート制限（429）: しばらく待って再試行してください。${retryAfter ? `（Retry-After: ${retryAfter}s）` : ""}`);
                        }

                        throw new Error(`HTTP ${status}: ${text.slice(0, 300)}`);
                    }

                    const data = await response.json();
                    const botResponse = data?.content ?? "（応答が空でした）";
                    this.state.isLoading = false;
                    this.elements.loadingIndicator.classList.add('hidden');
                    this.addSystemMessage(botResponse);

                } catch (error) {
                    console.error(error);
                    this.state.isLoading = false;
                    this.elements.loadingIndicator.classList.add('hidden');
                    
                    let errorMsg = `エラーが発生しました: ${error.message}`;
                    if (String(error.message).includes('429')) {
                        errorMsg =
                            "⚠️ **Groqの利用制限（レート/日次上限など）に達しました**\n\n" +
                            "少し時間を空けて再試行してください。\n" +
                            "※モデルによって「1日あたりの回数(RPD)」と「トークン上限(TPD)」が違います。";
                    }
                    
                    this.addSystemMessage(errorMsg);
                }
            }

            clearHistory() {
                if(confirm('会話履歴をリセットしますか？')) {
                    this.state.messages = [];
                    this.state.messagesByMode[this.state.mode] = this.state.messages;
                    this.elements.messageList.innerHTML = '';
                    this.addSystemMessage(this.getInitialGreeting(this.state.mode));
                }
            }

            openSettings() {
                this.loadProfileToUI();
                this.elements.settingsModal.classList.remove('hidden');
                void this.elements.settingsModal.offsetWidth;
                this.elements.settingsModal.classList.remove('opacity-0');
                this.elements.settingsModal.children[0].classList.remove('scale-95');
            }

            closeSettings() {
                this.elements.settingsModal.classList.add('opacity-0');
                this.elements.settingsModal.children[0].classList.add('scale-95');
                setTimeout(() => {
                    this.elements.settingsModal.classList.add('hidden');
                }, 200);
            }

            loadProfileToUI() {
                this.elements.profName.value = this.state.userProfile.name;
                this.elements.profDiagnosis.value = this.state.userProfile.diagnosis;
                this.elements.profAccommodations.value = this.state.userProfile.accommodations;
            }

            async saveProfile() {
                this.state.userProfile = {
                    name: this.elements.profName.value,
                    diagnosis: this.elements.profDiagnosis.value,
                    strengths: '', 
                    accommodations: this.elements.profAccommodations.value
                };
                
                if(isFirebaseReady && this.state.currentUser) {
                    try {
                        await setDoc(doc(db, "users", this.state.currentUser.uid), this.state.userProfile, { merge: true });
                        alert('プロフィールをクラウドに保存しました');
                    } catch(e) {
                        console.error(e);
                        let msg = `保存エラー: ${e.message}`;
                        if (e.code === 'permission-denied') {
                            msg = "【権限エラー】\nFirestoreのセキュリティルールを確認してください。";
                        }
                        alert(msg);
                    }
                } else {
                    localStorage.setItem('user_profile', JSON.stringify(this.state.userProfile));
                    alert('プロフィールをブラウザに保存しました');
                }
            }

            getInitialGreeting(mode) {
                const map = {
                    mock: '【基本の模擬面接コース】\n障害者雇用でよく聞かれる5つの質問（自己紹介、障害特性、配慮事項、強み、志望動機）を順番に行います。\nまずは「自己紹介と職務経歴」をお願いできますか？',
                    accommodation: '【配慮・定着支援】\n障害者雇用で重視される「長く安定して働けるか」を確認します。体調や対処法について教えてください。',
                    translate: '【本音翻訳】\n「働きたくない」「怖い」などの本音を入力してください。ポジティブな表現に変換します。',
                    reverse: '【逆質問作成】\n「残業ありますか？」など、企業に聞きたいことを入力してください。失礼にならない聞き方を提案します。'
                };
                return map[mode] || 'こんにちは';
            }

            generateSystemPrompt() {
                const p = this.state.userProfile;
                const profileText = `[応募者情報]\n名前:${p.name}\n特性:${p.diagnosis}\n配慮:${p.accommodations}`;
                const interviewerBase = `あなたは障害者雇用枠の採用面接を行う、ベテランの採用担当者です。\n相手（ユーザー）は就労移行支援事業所で訓練を受けている求職者です。\n${profileText}\n
                【あなたの行動指針】
                1. AIとしての自我を捨てること。「私はAIですが」といった発言は厳禁です。
                2. 過剰な賞賛の禁止。「素晴らしいです」「完璧です」などの褒め言葉は不要です。「なるほど」「分かりました」程度の相槌にとどめてください。
                3. 深掘りの徹底。回答が抽象的であれば、「具体的には？」「なぜそう思ったのですか？」と容赦なく深掘りしてください。
                4. 質問を行う場合は必ず1回につき1つだけ行ってください。

                【応答生成プロセス（内部処理）】
                回答する前に、以下のステップで思考してください（出力はしなくてよい）：
                1. 相手の回答に「矛盾」や「具体性の欠如」がないか探す。
                2. もしあれば、そこを突く質問や指摘を作る。
                3. なければ、次の選考項目（志望動機、配慮事項など）に進む。`;
                const advisorBase = `あなたは就労支援に詳しい就活アドバイザーです。\n相手（ユーザー）は就労移行支援事業所で訓練を受けている求職者です。\n${profileText}\n
                【あなたの行動指針】
                1. AIとしての自我を捨てること。「私はAIですが」といった発言は厳禁です。
                2. 過剰な賞賛の禁止。「素晴らしいです」「完璧です」などの褒め言葉は不要です。「なるほど」「分かりました」程度の相槌にとどめてください。
                3. 端的で実用的に。冗長な前置きは避け、実際に使える表現を優先してください。
                4. 一度に提示する提案は最大2パターンまでに留めてください。`;

                if (this.state.mode === 'translate') return `${advisorBase}\n本音翻訳は、障害のある求職者が就職活動でネガティブになりやすい点をリフレーミングし、前向きに伝えるためのコースです。ユーザーのネガティブな本音を、面接で使える誠実かつポジティブな表現に変換して提案してください。必ず「具体的改善点」と「改善案の完成文（面接で使える例文）を2つ以上」含め、例文は箇条書きで提示してください。さらに、実際の場面が想像できる「具体例」も1つ以上提示してください。合計7〜11文の長さにしてください。\n出力は必ず下記の見出しと順序で、各項目を改行して書いてください（見出しを省略しない）：\n【要点の理解】\n【具体的改善点】\n【改善案の完成文】\n- 例文1\n- 例文2\n【具体例】\n【意図の補足】\n【次の一言】`;
                if (this.state.mode === 'reverse') return `${advisorBase}\n逆質問は、企業に直接聞きにくい項目を、婉曲表現や言い換えで差し支えない質問に整えるコースです。ユーザーの「企業への率直な質問」を、意欲的かつ丁寧に聞こえる「逆質問」のフレーズに変換してください。必ず「具体的改善点」と「改善案の完成文（面接で使える例文）を2つ以上」含め、例文は箇条書きで提示してください。さらに「具体例（どんな場面で使うか）」を1つ以上示してください。合計8〜12文の長さにしてください。\n出力は必ず下記の見出しと順序で、各項目を改行して書いてください（見出しを省略しない）：\n【意図の言語化】\n【具体的改善点】\n【改善案の完成文】\n- 例文1\n- 例文2\n【具体例】\n【理由説明】\n【使い分けのコツ】\n【印象アップの工夫】\n【NG回避の注意】`;
                if (this.state.mode === 'accommodation') {
                    return `${interviewerBase}\n配慮・定着支援は、精神障害のある求職者が「障害者雇用での配慮事項」を具体的に考えるための参考・見本を示すコースです。以下の【質問リスト】を順番に進め、各質問は最大3回まで深掘りしてください。\n深掘りは「具体性不足・矛盾・再現性の欠如」がある時に行い、1ターンにつき質問は必ず1つだけにしてください。\n返答は7〜11文の長さにしてください。\n各返答には必ず「具体的改善点」と「改善案の完成文（面接で使える例文）を2つ以上」を含め、例文は箇条書きで提示してください。例文は精神障害の配慮として実際に使える具体的内容にしてください。\n各質問で3回目の深掘りまで進んだら、そのターンで必ず「要点メモ→完成文（面接で話す1段落）」も提示してください。\n出力は必ず下記の見出しと順序で、各項目を改行して書いてください（見出しを省略しない）：\n【相槌】\n【要点】\n【具体的改善点】\n【改善案の完成文】\n- 例文1\n- 例文2\n【深掘り質問】\n【具体化ヒント】\n【次に答えてほしい焦点】\n（3回目の深掘り時のみ）\n【要点メモ】\n【完成文】\n
                    【質問リスト】
                    1. 体調が崩れそうなときのサインはありますか？
                       深掘り1: 具体的にはどんな変化が出ますか？（身体/思考/行動のどれか）
                       深掘り2: そのサインはどのくらい前に出ますか？（時間・頻度）
                       深掘り3: そのサインが出た時、最初に何をしますか？
                    2. 不調を感じたとき、普段どんな対処をしていますか？
                       深掘り1: その中で一番効果があった方法はどれですか？
                       深掘り2: 職場で再現できる形にすると何になりますか？
                       深掘り3: 再現するために必要な条件は何ですか？
                    3. 職場にお願いしたい配慮は何ですか？
                       深掘り1: それが必要な理由は何ですか？
                       深掘り2: その配慮があると、何が改善しますか？
                       深掘り3: 代替案（優先度低め）もあるとしたら何ですか？
                    4. 困ったとき、どんな伝え方が一番伝わりやすいですか？
                       深掘り1: 口頭/チャット/メールのうち最適はどれですか？
                       深掘り2: タイミングはいつが良いですか？
                       深掘り3: 伝える相手の希望（直属/人事/支援員）はありますか？
                    5. 長く働くために、自分で意識している工夫はありますか？
                       深掘り1: その工夫を続けるコツは何ですか？
                       深掘り2: うまくいかない時のリカバリーは？
                       深掘り3: 周囲に協力してほしいことは？
\n
                    【返答テンプレ】
                    相槌1文 → 要点1文 → 具体的改善点 → 改善案の完成文（2つ以上・箇条書き） → 深掘り質問1つ → 具体化ヒント（短文） → 次に答えてほしい焦点（短文）。`;
                }
                
                return `${interviewerBase}\n
                基本コースは、精神障害のある求職者が就職活動・履歴書作成に使える文章を具体化するための模擬面接です。以下の【質問リスト】の順序に従って、1つずつ質問してください。
                必ず前の質問が終わってから次の質問へ進んでください。一度に複数の質問はしないでください。

                【質問リスト】
                1. まずは簡単に、自己紹介と職務経歴をお願いします。
                2. ご自身の障害特性や、体調管理で気をつけていることについて教えてください（不調のサインなど）。
                3. 業務にあたって、会社側に配慮してほしいことはありますか？
                4. ご自身の強みや、これまでの経験で活かせるスキルについて教えてください。
                5. 最後に、当社を志望された理由（志望動機）をお願いします。

                ※ユーザーの回答に対しては、まず「要点の要約」と「評価（良点/不足点）」を簡潔に述べてください。その上で、必ず「具体的改善点」と「改善案の完成文（面接で使える例文）を2つ以上」提示し、例文は箇条書きで示してください。例文は精神障害のある求職者がそのまま使える具体的な内容にしてください。
                返答は合計7〜11文の長さにしてください。\n出力は必ず下記の見出しと順序で、各項目を改行して書いてください（見出しを省略しない）：\n【要点の要約】\n【評価（良点/不足点）】\n【具体的改善点】\n【改善案の完成文】\n- 例文1\n- 例文2\n【次の質問】`;
            }
        }

        const instance = new InterviewPartnerApp();
    </script>
</body>
</html>
